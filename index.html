<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMT Rejection Outlook - Califonix</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>

<style>
  :root { 
    --primary: #002060; 
    --primary-light: #003366;
    --secondary: #E36C09; 
    --bg-light: #f4f7fa; 
    --white: #ffffff; 
    --shadow: 0 4px 15px rgba(0,0,0,0.1);
  }
  
  body { font-family: 'Segoe UI', 'Roboto', Helvetica, sans-serif; background: var(--bg-light); margin: 0; padding: 20px; color: #333; }
  
  /* --- 1. HEADER & LOGO --- */
  .main-header { display: flex; align-items: center; justify-content: space-between; background: white; padding: 15px 30px; border-radius: 12px; box-shadow: var(--shadow); margin-bottom: 25px; max-width: 1250px; margin-left: auto; margin-right: auto; border-left: 5px solid var(--secondary); }
  .header-left { display: flex; align-items: center; gap: 20px; }
  .logo-img { height: 55px; object-fit: contain; } /* Main Logo Style */
  .main-title h2 { margin: 0; color: var(--primary); font-weight: 800; font-size: 22px; }
  .main-title p { margin: 0; color: #777; font-size: 13px; font-weight: 500; }
  
  /* --- 2. CATEGORY SELECTOR --- */
  .category-select { padding: 10px 15px; border-radius: 6px; border: 2px solid var(--primary); color: var(--primary); font-weight: bold; cursor: pointer; background: #eef4ff; outline: none; transition: 0.3s; }
  .category-select:hover { background: var(--primary); color: white; }

  .container { max-width: 1250px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: var(--shadow); min-height: 80vh; }
  
  /* --- 3. NAVIGATION --- */
  .nav { display: flex; gap: 12px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 20px; flex-wrap: wrap; }
  button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; font-weight: 600; font-size: 14px; transition: all 0.2s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 8px; }
  button:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.15); opacity: 0.95; }
  
  /* Button Colors */
  .btn-blue { background: #0056b3; color: white; }
  .btn-green { background: #218838; color: white; }
  .btn-gray { background: #5a6268; color: white; }
  .btn-red { background: #c82333; color: white; }
  .btn-info { background: #138496; color: white; }
  .btn-purple { background: #6610f2; color: white; }
  .btn-orange { background: var(--secondary); color: white; }
  .btn-dark { background: #23272b; color: white; }

  /* --- 4. FORMS & INPUTS --- */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
  label { display: block; font-weight: 700; margin-bottom: 8px; font-size: 13px; color: #555; }
  input, select { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; background: #fdfdfd; transition: 0.3s; font-size: 14px; }
  input:focus, select:focus { border-color: var(--primary); outline: none; background: #fff; box-shadow: 0 0 0 4px rgba(0,32,96,0.1); }
  input[readonly] { background-color: #e9ecef; color: #666; cursor: not-allowed; }

  /* --- 5. DEFECT ROW STYLING --- */
  .defect-row { border: 1px solid #e1e4e8; padding: 15px; margin-bottom: 12px; border-radius: 8px; background: #fff; display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 2fr 2fr 1fr 0.5fr; gap: 10px; align-items: end; box-shadow: 0 2px 4px rgba(0,0,0,0.02); position: relative; overflow: hidden; }
  .defect-row::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--secondary); }
  .img-preview { height: 40px; display: none; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; }

  /* --- 6. KPI CARDS --- */
  .kpi-container { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap;}
  .kpi-card { flex: 1; min-width: 160px; background: linear-gradient(to bottom right, #fff, #f9fbfd); padding: 25px; border-radius: 12px; text-align: center; border-bottom: 5px solid var(--primary); box-shadow: var(--shadow); transition: transform 0.3s; }
  .kpi-card:hover { transform: translateY(-5px); }
  .kpi-card div:first-child { color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
  .kpi-val { font-size: 36px; font-weight: 800; margin-top: 10px; color: #222; }

  /* --- 7. REPORT & CHARTS --- */
  /* Ensures PDF prints clearly */
  .report-box { width: 1100px !important; margin: 0 auto; border: none; padding: 40px; display: none; margin-top: 20px; background: #fff; box-shadow: 0 5px 30px rgba(0,0,0,0.15); overflow: hidden; border-radius: 8px; }
  
  .report-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px; }
  .report-header img { height: 60px; }
  .report-title-block { text-align: right; }
  .report-title-block h1 { margin: 0; color: var(--primary); font-size: 24px; font-weight: 800; text-transform: uppercase; }
  .report-title-block p { margin: 5px 0 0; color: #666; font-size: 14px; }

  .chart-stacked { display: block; width: 100%; margin-bottom: 30px; page-break-inside: avoid !important; }
  .chart-full { width: 100%; height: 380px; border: 1px solid #eee; padding: 15px; background: #fff; border-radius: 8px; }
  .chart-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
  .chart-box { flex: 1; min-width: 300px; border: 1px solid #eee; padding: 15px; background: #fff; border-radius: 8px; height: 380px; }

  /* Analysis List */
  .analysis-item { position: relative; display: flex; border: 1px solid #f0f0f0; padding: 15px; margin-bottom: 12px; gap: 15px; background: #fdfdfd; border-left: 5px solid var(--primary); border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
  
  /* Tables */
  .rem-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 13px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .rem-table th, .rem-table td { border: 1px solid #dee2e6; padding: 12px; text-align: center; }
  .rem-table th { background: #343a40; color: white; text-transform: uppercase; font-size: 12px; letter-spacing: 0.5px; }

  /* --- 8. MULTI SELECT --- */
  .multiselect { width: 100%; position: relative; }
  .selectBox { position: relative; cursor: pointer; }
  .selectBox select { width: 100%; font-weight: bold; background: #fff; }
  .overSelect { position: absolute; left: 0; right: 0; top: 0; bottom: 0; }
  #checkboxes { display: none; border: 1px solid #ccc; max-height: 200px; overflow-y: scroll; position: absolute; width: 100%; background: white; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 0 0 8px 8px; }
  #checkboxes label { display: block; padding: 10px; margin: 0; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px; }
  #checkboxes label:hover { background-color: #f1f8ff; color: var(--primary); }
  #checkboxes input { width: auto; margin-right: 10px; }

  /* --- 9. ATTRACTIVE PREVIEW MODAL --- */
  .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
  .modal-content { background-color: #fff; margin: 2% auto; padding: 0; border: none; width: 80%; max-width: 950px; border-radius: 16px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); overflow: hidden; animation: slideUp 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); }
  @keyframes slideUp { from {transform: translateY(50px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
  
  .prev-header { 
      background: linear-gradient(135deg, var(--primary) 0%, #004080 100%); 
      color: white; padding: 25px 40px; 
      display: flex; justify-content: space-between; align-items: center; 
      border-bottom: 5px solid var(--secondary);
  }
  .prev-logo-area { display: flex; align-items: center; gap: 15px; }
  .prev-logo-area img { height: 45px; background: white; padding: 5px; border-radius: 6px; }
  .prev-title h3 { margin: 0; font-size: 20px; font-weight: 400; opacity: 0.9; }
  .prev-title h2 { margin: 0; font-size: 28px; font-weight: 800; letter-spacing: 1px; }
  
  .close { color: rgba(255,255,255,0.8); font-size: 32px; cursor: pointer; transition: 0.2s; font-weight: 100; }
  .close:hover { color: white; transform: rotate(90deg); }
  
  .prev-body { padding: 40px; background: #f8f9fa; }
  
  /* Info Grid in Preview */
  .prev-info-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
  .info-tag { background: white; padding: 15px; border-radius: 8px; border-left: 4px solid #ddd; box-shadow: 0 2px 6px rgba(0,0,0,0.03); }
  .info-tag span { display: block; font-size: 11px; color: #888; text-transform: uppercase; margin-bottom: 5px; font-weight: 700; }
  .info-tag strong { font-size: 16px; color: #333; }
  .info-tag.highlight { border-left-color: var(--secondary); }

  /* Summary Section in Preview */
  .summary-banner { display: flex; background: white; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #edf2f7; }
  .sum-col { flex: 1; padding: 25px; text-align: center; border-right: 1px solid #edf2f7; position: relative; }
  .sum-col:last-child { border-right: none; }
  .sum-label { font-size: 12px; color: #666; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
  .sum-number { font-size: 32px; font-weight: 900; color: var(--primary); margin-top: 5px; }
  .sum-number.bad { color: #e53e3e; }
  
  /* Table in Preview */
  .prev-table-wrap { border-radius: 10px; overflow: hidden; box-shadow: 0 0 0 1px #e2e8f0; background: white; }
  .p-table { width: 100%; border-collapse: collapse; }
  .p-table th { background: #edf2f7; color: #4a5568; padding: 15px; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; }
  .p-table td { padding: 15px; border-bottom: 1px solid #edf2f7; color: #2d3748; font-size: 14px; }
  .p-table tr:last-child td { border-bottom: none; }
  .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; background: #ebf8ff; color: #3182ce; }
  
  .prev-footer { background: #fff; padding: 20px 40px; text-align: right; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 15px; }
  
  #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 3000; text-align: center; padding-top: 250px; }
  .loader-spinner { border: 6px solid #f3f3f3; border-top: 6px solid var(--secondary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px auto; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  
  .category-switch { display: flex; justify-content: center; margin-bottom: 30px; }
  .cat-btn { padding: 15px 50px; border: 1px solid #ccc; background: #e9ecef; cursor: pointer; font-weight: bold; font-size: 16px; transition: 0.3s; flex: 1; max-width: 300px; text-align: center; color: #555; }
  .cat-btn:first-child { border-radius: 30px 0 0 30px; border-right: none; }
  .cat-btn:last-child { border-radius: 0 30px 30px 0; border-left: none; }
  .cat-btn.active-buds { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,32,96,0.3); z-index: 1; }
  .cat-btn.active-case { background: var(--secondary); color: white; border-color: var(--secondary); box-shadow: 0 4px 10px rgba(227,108,9,0.3); z-index: 1; }
  
  .theme-case { --primary: #E36C09; --primary-light: #e67e22; --secondary: #002060; }
</style>
</head>
<body>

<div id="loader">
    <div class="loader-spinner"></div>
    <div style="font-size:18px; font-weight:bold; color:#555;">Processing Data...</div>
</div>

<div class="main-header">
    <div class="header-left">
        <!-- LOGO HERE -->
        <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="logo-img" alt="Califonix Logo">
        <div class="main-title">
            <h2>SMT Rejection Outlook</h2>
            <p>Quality Control Management System</p>
        </div>
    </div>
    <div>
        <label>Current Dashboard:</label>
        <select class="category-select" id="cat_select" onchange="switchCategory(this.value)">
            <option value="Earbuds">üéß Earbuds</option>
            <option value="ChargingCase">üîã Charging Case</option>
        </select>
    </div>
</div>

<div id="previewModal" class="modal">
  <div class="modal-content">
    <div class="prev-header">
        <div class="prev-logo-area">
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
            <div class="prev-title">
                <h3>Califonix Systems</h3>
                <h2>Data Entry Preview</h2>
            </div>
        </div>
        <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div class="prev-body" id="previewBody"></div>
    <div class="prev-footer" id="previewFooter"></div>
  </div>
</div>

<div class="container">
  <div class="category-switch">
      <div id="btn_earbuds" class="cat-btn active-buds" onclick="switchCategory('Earbuds')">üéß Earbuds Dashboard</div>
      <div id="btn_case" class="cat-btn" onclick="switchCategory('ChargingCase')">üîã Charging Case Dashboard</div>
  </div>

  <div class="nav">
    <button class="btn-blue" onclick="showPage('dashboard')">üìä Dashboard</button>
    <button class="btn-gray" onclick="showPage('entry')">üìù Data Entry</button>
    <button class="btn-green" onclick="showPage('report')">üìë Overall Report</button>
    <button class="btn-purple" onclick="showPage('model_report')">üì± Model Report</button>
    <button class="btn-orange" onclick="showPage('defect_report')">üîç Defect Report</button>
    <button class="btn-dark" onclick="showPage('month_report')">üìÖ Month Wise</button>
  </div>

  <!-- 1. DASHBOARD -->
  <div id="dashboard">
    <div class="form-grid">
      <div><label>From Date</label><input type="date" id="dash_from"></div>
      <div><label>To Date</label><input type="date" id="dash_to"></div>
      <div style="display:flex; align-items:end;"><button class="btn-blue" onclick="renderDash()" style="width:100%">Filter Data</button></div>
    </div>
    <div class="kpi-container">
       <div class="kpi-card"><div>Overall Rejection</div><div class="kpi-val" id="k_all">0%</div></div>
       <div class="kpi-card" style="border-bottom-color:#28a745;"><div>Floor 1</div><div class="kpi-val" id="k_f1">0%</div></div>
       <div class="kpi-card" style="border-bottom-color:#ff9800;"><div>Floor 2</div><div class="kpi-val" id="k_f2">0%</div></div>
       <div class="kpi-card" style="border-bottom-color:#6f42c1;"><div>Basement</div><div class="kpi-val" id="k_fb">0%</div></div>
    </div>
    <div class="chart-row">
        <div class="chart-box" id="dash_chart_model" style="height:350px;"></div>
        <div class="chart-box" id="dash_chart_defect" style="height:350px;"></div>
    </div>
    <div style="overflow-x:auto; margin-top:20px;">
      <table class="rem-table">
        <thead><tr><th>Date</th><th>Shift</th><th>Line</th><th>Model</th><th>Input</th><th>Defects</th><th>Rej %</th><th>Action</th></tr></thead>
        <tbody id="dash_table"></tbody>
      </table>
    </div>
  </div>

  <!-- 2. DATA ENTRY -->
  <div id="entry" style="display:none;">
    <h3 style="color:var(--primary); border-bottom:2px solid #eee; padding-bottom:10px;">üìù Add / Edit Record</h3>
    <input type="hidden" id="edit_index"><input type="hidden" id="edit_sheet_name">
    <div class="form-grid">
      <div><label>Date</label><input type="date" id="e_date"></div>
      <div><label>Shift</label><select id="e_shift"><option value="A">Shift A</option><option value="B">Shift B</option><option value="C">Shift C</option></select></div>
      <div><label>Line</label><input type="number" id="e_line" placeholder="1-24"></div>
      <div><label>Model</label><select id="e_model"><option value="">Select Model</option></select></div>
      <div><label>Input Qty</label><input type="number" id="e_input" oninput="calcTotal()"></div>
      <div><label>Operator/Prep By</label><input type="text" id="e_prep"></div>
    </div>
    
    <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
        <h4 style="margin-top:0; color:var(--primary);">Defect Details</h4>
        <div id="defect_wrapper"></div>
        <button class="btn-gray" onclick="addDefectRow()">+ Add Another Defect</button>
    </div>

    <div style="margin-top:20px; padding:20px; background:#e8f0fe; border-radius:8px; border:1px solid #b3d7ff;">
       <h4 style="margin-top:0; color:#004085;">Summary</h4>
       <div class="form-grid">
           <div><label>Total Defect Qty</label><input type="text" id="lbl_tot" readonly></div>
           <div><label>Overall Defect Rate %</label><input type="text" id="lbl_rate" readonly style="color:red; font-weight:bold; font-size:16px;"></div>
           <div style="display:flex; align-items:end;">
             <button class="btn-blue" onclick="previewEntry()" style="width:100%; font-size:16px; justify-content:center;">üëÅÔ∏è PREVIEW & SAVE</button>
           </div>
       </div>
    </div>
  </div>

  <!-- 3. REPORT TEMPLATES (WITH LOGO) -->
  
  <!-- Overall Report -->
  <div id="report" style="display:none;">
    <div class="form-grid no-print">
      <div><label>From Date</label><input type="date" id="r_date_start"></div>
      <div><label>To Date</label><input type="date" id="r_date_end"></div>
      <div style="display:flex; align-items:end; gap:10px;">
        <button class="btn-blue" onclick="genReport()">Generate</button>
        <button class="btn-green" onclick="downloadPDF('print_area', 'Overall_Report.pdf')">Download PDF</button>
      </div>
    </div>
    <div id="print_area" class="report-box">
      <div class="report-header">
          <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
          <div class="report-title-block">
              <h1>Overall Analysis</h1>
              <p>Period: <span id="r_subtitle">--</span></p>
          </div>
      </div>
      <div style="display:flex; gap:15px; margin-bottom:20px;">
          <div class="kpi-card"><div>Total Input</div><div class="kpi-val" id="r_inp">0</div></div>
          <div class="kpi-card" style="border-bottom-color:#dc3545;"><div>Total Defect</div><div class="kpi-val" id="r_def">0</div></div>
          <div class="kpi-card" style="border-bottom-color:#E36C09;"><div>Rejection Rate</div><div class="kpi-val" id="r_rate_val">0%</div></div>
      </div>
      <div class="chart-stacked"><div class="chart-full" id="trend_chart_div"></div></div>
      <div class="chart-stacked"><div class="chart-full" id="model_chart_div"></div></div>
      <div class="chart-stacked"><div class="chart-full" id="pareto_chart_div"></div></div>
      <h4 style="border-bottom:2px solid #333; margin-top:30px;">üèÜ Top 5 Defects Analysis <small>(Click text to edit)</small></h4><div id="analysis_list"></div>
      <h4 style="border-bottom:2px solid #333; margin-top:30px;">üìâ Remaining Defects</h4><table class="rem-table"><tbody id="remaining_list"></tbody></table>
    </div>
  </div>

  <!-- Model Report -->
  <div id="model_report" style="display:none;">
    <div class="form-grid no-print">
      <div><label>From</label><input type="date" id="m_date_start"></div>
      <div><label>To</label><input type="date" id="m_date_end"></div>
      <div>
        <label>Select Models (Multi)</label>
        <div class="multiselect">
            <div class="selectBox" onclick="showCheckboxes()">
                <select><option>Select Models</option></select>
                <div class="overSelect"></div>
            </div>
            <div id="checkboxes"></div>
        </div>
      </div>
      <div style="display:flex; align-items:end; gap:10px;">
        <button class="btn-purple" onclick="genModelReport()">View</button>
        <button class="btn-green" onclick="downloadPDF('model_print_area', 'Model_Report.pdf')">PDF</button>
      </div>
    </div>
    <div id="model_print_area" class="report-box">
      <div class="report-header">
          <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
          <div class="report-title-block">
              <h1>Model Report</h1>
              <p>Period: <span id="m_subtitle">--</span></p>
          </div>
      </div>
      <div style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #ddd; margin-bottom:20px; display:flex; justify-content:space-around; text-align:center;">
          <div><div style="font-size:12px; color:#888;">MODELS</div><div style="font-weight:bold; color:var(--primary);" id="m_name_disp">--</div></div>
          <div><div style="font-size:12px; color:#888;">INPUT</div><div style="font-weight:bold;" id="m_inp">0</div></div>
          <div><div style="font-size:12px; color:#888;">DEFECT</div><div style="font-weight:bold; color:#dc3545;" id="m_def">0</div></div>
          <div><div style="font-size:12px; color:#888;">RATE</div><div style="font-weight:bold; color:#E36C09;" id="m_rate_val">0%</div></div>
      </div>
      <div class="chart-stacked"><div class="chart-full" id="m_trend_chart"></div></div>
      <div class="chart-stacked"><div class="chart-full" id="m_pareto_chart"></div></div>
      <h4 style="border-bottom:2px solid #333;">üèÜ Top Defects (Editable)</h4><div id="m_analysis_list"></div>
      <table class="rem-table"><tbody id="m_remaining_list"></tbody></table>
    </div>
  </div>

  <!-- Defect Report -->
  <div id="defect_report" style="display:none;">
    <div class="form-grid no-print">
      <div><label>From</label><input type="date" id="d_date_start"></div>
      <div><label>To</label><input type="date" id="d_date_end"></div>
      <div><label>Select Defect</label><select id="d_defect_select"></select></div>
      <div style="display:flex; align-items:end; gap:5px;">
        <button class="btn-orange" onclick="genDefectWiseReport()">Generate</button>
        <button class="btn-green" onclick="downloadPDF('defect_print_area', 'Defect_Report.pdf')">PDF</button>
        <button class="btn-purple" onclick="downloadProfessionalPPT('Defect')">PPT</button>
      </div>
    </div>
    <div id="defect_print_area" class="report-box">
      <div class="report-header">
          <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
          <div class="report-title-block">
              <h1>Defect Analysis</h1>
              <p>Period: <span id="d_subtitle">--</span></p>
          </div>
      </div>
      <div style="background:#fff3cd; padding:15px; border-radius:8px; border:1px solid #ffeeba; margin-bottom:20px; display:flex; justify-content:space-around; text-align:center;">
          <div><div style="font-size:12px; color:#856404;">DEFECT TYPE</div><div style="font-weight:bold; color:#d32f2f;" id="d_name_disp">--</div></div>
          <div><div style="font-size:12px; color:#856404;">TOTAL QTY</div><div style="font-weight:bold;" id="d_tot_qty">0</div></div>
          <div><div style="font-size:12px; color:#856404;">MODELS AFFECTED</div><div style="font-weight:bold;" id="d_aff_models">0</div></div>
      </div>
      <div class="chart-stacked"><div class="chart-full" id="d_contrib_chart"></div></div>
      <h4 style="border-bottom:2px solid #333;">üîç Analysis & Actions</h4><div id="d_analysis_list"></div>
      <table class="rem-table" id="defect_detail_table"><tbody id="defect_detail_body"></tbody></table>
    </div>
  </div>

  <!-- Month Wise Report -->
  <div id="month_report" style="display:none;">
      <div class="form-grid no-print">
          <div><label>Select Month</label><input type="month" id="mo_picker"></div>
          <div style="display:flex; align-items:end; gap:10px;">
              <button class="btn-dark" onclick="genMonthReport()">Load Dashboard</button>
              <button class="btn-green" onclick="downloadPDF('month_print_area', 'Monthly_Report.pdf')">PDF</button>
              <button class="btn-purple" onclick="downloadProfessionalPPT('Month')">Professional PPT</button>
          </div>
      </div>
      <div id="month_print_area" class="report-box">
          <div class="report-header">
              <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
              <div class="report-title-block">
                  <h1>Monthly Performance</h1>
                  <p id="mo_subtitle">--</p>
              </div>
          </div>
          
          <div style="display:flex; gap:15px; margin-bottom:30px;">
              <div class="kpi-card" style="border-bottom-color:var(--primary);"><div>Total Input</div><div class="kpi-val" id="mo_inp">0</div></div>
              <div class="kpi-card" style="border-bottom-color:#dc3545;"><div>Total Defects</div><div class="kpi-val" id="mo_def">0</div></div>
              <div class="kpi-card" style="border-bottom-color:var(--secondary);"><div>Rejection %</div><div class="kpi-val" id="mo_rate">0%</div></div>
          </div>

          <div class="chart-row">
              <div class="chart-box" style="width:100%;"><div id="mo_trend_chart" style="width:100%; height:300px;"></div></div>
          </div>
          <div class="chart-row">
            <div class="chart-box"><div id="mo_model_chart" style="width:100%; height:300px;"></div></div>
            <div class="chart-box"><div id="mo_pareto_chart" style="width:100%; height:300px;"></div></div>
          </div>
          
          <h3 style="border-left:5px solid var(--primary); padding-left:10px; margin-top:30px;">Analysis Overview (Editable)</h3>
          <div id="mo_analysis_list"></div>
      </div>
  </div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbweFBgyW1LR3SLr0wHrt_dUXRXmN1qGwNjbmhcmCTLMzjm3wjTeNA1wofzAz801zEvmng/exec";
const LOGO_URL = "https://i.postimg.cc/5y7SN4xc/logo.png";

const MASTER_MODELS = [
    "Ad Unity ANC", "Ace", "Ad 111v2", "Ad 118", "Ad 120", "Ad 121Pro Plus", "Ad 131 Elite Anc", "Ad 131 Gen 2", 
    "Ad 131 Pro Buds", "Ad 138 Gen 2", "Ad 141 Anc", "Ad 141 Anc Elite", "Ad 141 Gen 2", "Ad 141 Pro Buds",
    "Ad 148 Gen 2", "Ad 155", "Ad 161 Anc", "Ad 161 Anc Elite", "Ad 161 N", "Ad 181 Pro", "Ad 191 Anc", "Ad 192", 
    "Ad 212", "Ad 213", "Ad 280 Anc", "Ad 300", "Ad 301", "Ad 311 Pro", "Ad 313", "Ad 701 Anc", "AD 71",
    "Ad 800", "Ad 800 Hidef", "Ad 91", "Ad 91 Prime", "Ad Ace Gen 2", "Ad Alpha Gen 2", "AD Hype", "AD Kick", 
    "Ad Nirvana Crystal", "Ad Nirvana Iris", "Ad Nirvana X", "Ad Plus 311", "Ad Plus 318", "Ad Prime 412", 
    "Ad Prime 513 Anc", "Ad Primo", "Ad Pulse", "AD Supreme", "Ad Ultra Pro", "Ad100", "Ad121 Pro", "Ad125",
    "Ad131", "Ad131 Pro", "Ad138", "Ad138 Pro", "Ad141", "Ad148", "Ad161", "AD161 Pro-Buds", "AD163", "Ad170", 
    "AD181", "AD183", "Ad190", "AD191 G", "Airdopes 207", "Alpha", "Amazon basics", "Atom 81 Pro", "Atom 83", 
    "Atom81", "Dashcam Hive E1", "Dashcam Hive F1", "HMD P50", "HMD P60", "HMD P70", "HMD S60", "HMD X50", 
    "HMD X50 Pro", "IMT 100", "IMT101", "IMT121", "IMT128", "IMT131", "IMT161", "IMT181", "Joy", "Max", 
    "Nirvana", "Nirvana Ion (ANC)", "Nirvana Ion ANC Pro", "Nirvana ION N Mold", "R 195 Pro", "Ultra Plus", "Zing"
];
const MASTER_DEFECTS = [
    "Body Sensor Fail", "Single LED glow", "Channel Fail", "SMD Component damaged", "DUT Mode Fail", 
    "Electric sound", "Heating", "High Current", "Enquiry", "LED Not glow", "LED Miss", "Low current", 
    "Secondary MIC Fail", "Talk MIC Fail", "Not On", "POGO Pin shift", "Software skip", "RF Fail", "CTC Fail", 
    "Speaker Fail", "Scrap", "Extra Burr", "Mic Distortion"
];

const CONFIG = {
    Earbuds: { defects: MASTER_DEFECTS, models: MASTER_MODELS },
    ChargingCase: { defects: MASTER_DEFECTS, models: MASTER_MODELS }
};

let currentCategory = "Earbuds";
let rawData = { earbuds: [], charging_case: [] }; 
let currentData = []; 
let chartInstances = {}; 

google.charts.load('current', {'packages':['corechart', 'bar']});

window.onload = () => {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('e_date').value = today;
    document.getElementById('dash_from').value = today;
    document.getElementById('mo_picker').value = today.substring(0, 7);
    document.getElementById('cat_select').value = "Earbuds";
    loadAllData();
};

function switchCategory(cat) {
    currentCategory = cat;
    document.getElementById('btn_earbuds').className = cat === 'Earbuds' ? 'cat-btn active-buds' : 'cat-btn';
    document.getElementById('btn_case').className = cat === 'ChargingCase' ? 'cat-btn active-case' : 'cat-btn';
    document.getElementById('cat_select').value = cat;
    document.body.className = cat === 'Earbuds' ? 'theme-earbuds' : 'theme-case';
    currentData = (cat === 'Earbuds') ? rawData.earbuds : rawData.charging_case;
    updateDropdowns();
    renderDash();
    showPage('dashboard');
}

function updateDropdowns(){
    let catConfig = CONFIG[currentCategory];
    let dList = document.getElementById('e_model');
    dList.innerHTML = '<option value="">Select Model</option>';
    let existingModels = [...new Set(currentData.map(r=>r[2]))];
    let allModels = [...new Set([...catConfig.models, ...existingModels])].sort();
    
    // Fill Single Select
    allModels.forEach(m => { 
        let opt = document.createElement('option'); opt.value = m; opt.innerText = m;
        dList.appendChild(opt); 
    });

    // Fill Defect Select
    let dSelect = document.getElementById('d_defect_select');
    dSelect.innerHTML = '<option value="">Select Defect</option>' + catConfig.defects.map(d=>`<option value="${d}">${d}</option>`).join('');

    // Fill Multi-Select
    let cbContainer = document.getElementById('checkboxes');
    cbContainer.innerHTML = "";
    allModels.forEach(m => {
        let lbl = document.createElement('label');
        lbl.innerHTML = `<input type="checkbox" value="${m}" />${m}`;
        cbContainer.appendChild(lbl);
    });
}

// MULTI SELECT LOGIC
let expanded = false;
function showCheckboxes() {
  let checkboxes = document.getElementById("checkboxes");
  if (!expanded) { checkboxes.style.display = "block"; expanded = true; } 
  else { checkboxes.style.display = "none"; expanded = false; }
}

function showPage(id){
  document.querySelectorAll('#dashboard, #entry, #report, #model_report, #defect_report, #month_report').forEach(d => d.style.display='none');
  document.getElementById(id).style.display='block';
}

function formatPct(val) {
    let s = String(val); if(s.includes("%")) return s;
    let n = parseFloat(s); return isNaN(n) ? "0.00%" : (n * 100).toFixed(2) + "%";
}

function addDefectRow(data = null){
  const div = document.createElement('div'); div.className = 'defect-row';
  let options = CONFIG[currentCategory].defects.map(d => `<option value="${d}">${d}</option>`).join("");
  div.innerHTML = `<div><label>Defect Name</label><select class="d-name"><option value="">Select</option>${options}</select></div><div><label>Loc/Ref</label><input class="d-ref"></div><div><label>Qty</label><input type="number" class="d-qty" oninput="calcTotal()"></div><div><label>Defect %</label><input class="d-rate" readonly></div><div><label>Analysis</label><input class="d-ana"></div><div><label>Action</label><input class="d-act"></div><div><label>Image</label><input type="file" accept="image/*" onchange="handleImg(this)"></div><div style="text-align:center;"><img class="img-preview"><input type="hidden" class="d-base64"><button class="btn-red" onclick="this.parentElement.parentElement.remove(); calcTotal()">X</button></div>`;
  document.getElementById('defect_wrapper').appendChild(div);
  if(data){
      div.querySelector('.d-name').value = data.name; div.querySelector('.d-qty').value = data.qty;
      div.querySelector('.d-rate').value = formatPct(data.rate||0); div.querySelector('.d-ana').value = data.analysis;
      div.querySelector('.d-act').value = data.action; div.querySelector('.d-ref').value = data.ref||"";
      if(data.image) { div.querySelector('.img-preview').src = data.image; div.querySelector('.img-preview').style.display='block'; div.querySelector('.d-base64').value=data.image; }
  }
}
function handleImg(input){ if(input.files && input.files[0]){ const r = new FileReader(); r.onload = (e) => { let i = new Image(); i.onload = () => { let c = document.createElement('canvas'); let x = c.getContext('2d'); let w=i.width, h=i.height; if(w>600){h*=600/w;w=600;} c.width=w; c.height=h; x.drawImage(i,0,0,w,h); let row=input.closest('.defect-row'); row.querySelector('.img-preview').src=c.toDataURL('image/jpeg',0.6); row.querySelector('.img-preview').style.display='block'; row.querySelector('.d-base64').value=c.toDataURL('image/jpeg',0.6); }; i.src = e.target.result; }; r.readAsDataURL(input.files[0]); } }
function calcTotal(){ 
    let inp = +document.getElementById('e_input').value || 0; let tot = 0;
    document.querySelectorAll('.d-qty').forEach(i => tot += (+i.value||0));
    document.getElementById('lbl_tot').value = tot;
    document.getElementById('lbl_rate').value = inp > 0 ? (tot/inp*100).toFixed(2)+"%" : "0.00%";
    document.querySelectorAll('.defect-row').forEach(row => { let q = +row.querySelector('.d-qty').value || 0; row.querySelector('.d-rate').value = (inp>0 && q>0) ? (q/inp*100).toFixed(2)+"%" : "0%"; });
}

// --- COLORFUL PREVIEW MODAL ---
function previewEntry() { renderPreviewModal(getEntryData()); }
function getEntryData() {
    let d = {
        date: document.getElementById('e_date').value, shift: document.getElementById('e_shift').value,
        line: document.getElementById('e_line').value, model: document.getElementById('e_model').value,
        input: document.getElementById('e_input').value, total: document.getElementById('lbl_tot').value,
        rate: document.getElementById('lbl_rate').value, prep: document.getElementById('e_prep').value, defects: []
    };
    document.querySelectorAll('.defect-row').forEach(r => {
        d.defects.push({
            name: r.querySelector('.d-name').value, ref: r.querySelector('.d-ref').value,
            qty: r.querySelector('.d-qty').value, rate: r.querySelector('.d-rate').value,
            ana: r.querySelector('.d-ana').value, img: r.querySelector('.d-base64').value
        });
    });
    return d;
}
function previewEntryFromRow(idx, r) {
    let d = { date: r[0], shift: r[8]||'-', line: r[1], model: r[2], input: r[3], total: r[4], rate: formatPct(r[5]), prep: r[6], defects: [] };
    try { let defs = JSON.parse(r[7]); defs.forEach(x => { 
        let dr = (+r[3]>0) ? ((+x.qty)/r[3]*100).toFixed(2)+"%" : "0%";
        d.defects.push({ name:x.name, ref:x.ref, qty:x.qty, rate:dr, ana:x.analysis, img:x.image }); 
    }); } catch(e){}
    renderPreviewModal(d, true);
}

function renderPreviewModal(data, isReadOnly=false){
    let html = `
    <div class="prev-info-grid">
        <div class="info-tag highlight"><span>MODEL</span><strong>${data.model}</strong></div>
        <div class="info-tag"><span>DATE</span><strong>${data.date}</strong></div>
        <div class="info-tag"><span>SHIFT / LINE</span><strong>${data.shift} / ${data.line}</strong></div>
        <div class="info-tag"><span>OPERATOR</span><strong>${data.prep}</strong></div>
    </div>
    
    <div class="summary-banner">
        <div class="sum-col">
            <div class="sum-label">INPUT QUANTITY</div>
            <div class="sum-number">${data.input}</div>
        </div>
        <div class="sum-col">
            <div class="sum-label">TOTAL DEFECTS</div>
            <div class="sum-number bad">${data.total}</div>
        </div>
        <div class="sum-col">
            <div class="sum-label">REJECTION RATE</div>
            <div class="sum-number">${data.rate}</div>
        </div>
    </div>
    
    <div class="prev-table-wrap">
        <table class="p-table">
            <thead><tr><th>Defect Type</th><th>Ref ID</th><th>Qty</th><th>%</th><th>Analysis</th><th>Image</th></tr></thead>
            <tbody>
    `;
    data.defects.forEach(d => {
        let img = d.img ? `<img src="${d.img}" style="height:30px; border-radius:4px; cursor:zoom-in" onclick="window.open(this.src)">` : '<span style="color:#ccc">No Img</span>';
        html += `<tr><td><span class="badge">${d.name}</span></td><td>${d.ref||'-'}</td><td><b>${d.qty}</b></td><td>${d.rate}</td><td>${d.ana||'-'}</td><td>${img}</td></tr>`;
    });
    html += `</tbody></table></div>`;
    document.getElementById('previewBody').innerHTML = html;
    
    let ft = document.getElementById('previewFooter');
    if(!isReadOnly) ft.innerHTML = `<button class="btn-gray" onclick="closeModal()">Edit</button><button class="btn-green" onclick="saveData()">‚úÖ Submit Data</button>`;
    else ft.innerHTML = `<button class="btn-gray" onclick="closeModal()">Close</button>`;
    document.getElementById('previewModal').style.display = "block";
}
function closeModal() { document.getElementById('previewModal').style.display = "none"; }

// --- SAVE & LOAD ---
async function saveData(){
  if(!API_URL.includes("script.google.com")){ alert("Please setup API URL!"); return; }
  closeModal(); document.getElementById('loader').style.display = 'block';
  let d = getEntryData();
  let payload = { action: "save", category: currentCategory, sheetName: currentCategory==="ChargingCase"?"Data_ChargingCase":"Data_Earbuds", rowIndex: document.getElementById('edit_index').value, date: d.date, shift: d.shift, line: d.line, model: d.model, input: d.input, totalDef: d.total, rejRate: d.rate, prep: d.prep, defects: d.defects.map(x=>({name:x.name, ref:x.ref, qty:x.qty, rate:x.rate, analysis:x.ana, action:"", image:x.img})), defectList: CONFIG[currentCategory].defects };
  try { await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) }); alert("‚úÖ Saved!"); location.reload(); } 
  catch(e) { alert("‚ùå Error"); } finally { document.getElementById('loader').style.display = 'none'; }
}
async function loadAllData(){
  try { let res = await fetch(API_URL); rawData = await res.json(); switchCategory("Earbuds"); } catch(e) { console.log(e); }
}

// --- DASHBOARD ---
function renderDash(){
  let from = document.getElementById('dash_from').value; let to = document.getElementById('dash_to').value || from;
  let tBody = document.getElementById('dash_table'); tBody.innerHTML = "";
  let stats = { all_i:0, all_d:0, f1_i:0, f1_d:0, f2_i:0, f2_d:0, fb_i:0, fb_d:0 };
  let mMode = {}, mDef = {};

  currentData.forEach((r, idx) => {
    if(r[0] < from || r[0] > to) return;
    let ln = +r[1], inp = +r[3], def = +r[4];
    stats.all_i += inp; stats.all_d += def;
    if(ln<=8) { stats.f1_i+=inp; stats.f1_d+=def; } else if(ln<=16) { stats.f2_i+=inp; stats.f2_d+=def; } else { stats.fb_i+=inp; stats.fb_d+=def; }
    if(!mMode[r[2]]) mMode[r[2]]={d:0}; mMode[r[2]].d+=def;
    try { JSON.parse(r[7]).forEach(d=>{ if(!mDef[d.name]) mDef[d.name]=0; mDef[d.name]+=(+d.qty); }); } catch(e){}
    let clr = parseFloat(r[5]) > 1 ? 'red' : (parseFloat(r[5])>0?'orange':'green');
    tBody.innerHTML += `<tr><td>${r[0]}</td><td>${r[8]}</td><td>${r[1]}</td><td><b>${r[2]}</b></td><td>${inp}</td><td>${def}</td><td style="color:${clr};font-weight:bold;">${formatPct(r[5])}</td><td><button class="btn-info" onclick='previewEntryFromRow(${idx}, ${JSON.stringify(r)})'>View</button> <button class="btn-blue" onclick='editRow(${idx}, ${JSON.stringify(r)})'>Edit</button></td></tr>`;
  });
  const rate = (d,i) => i>0 ? (d/i*100).toFixed(2)+"%" : "0.00%";
  document.getElementById('k_all').innerText = rate(stats.all_d, stats.all_i);
  document.getElementById('k_f1').innerText = rate(stats.f1_d, stats.f1_i);
  document.getElementById('k_f2').innerText = rate(stats.f2_d, stats.f2_i);
  document.getElementById('k_fb').innerText = rate(stats.fb_d, stats.fb_i);
  
  // Charts
  let mA = [['Model','Defects',{role:'annotation'}]], dA = [['Defect','Qty',{role:'annotation'}]];
  Object.keys(mMode).sort((a,b)=>mMode[b].d-mMode[a].d).slice(0,5).forEach(k=>mA.push([k,mMode[k].d,mMode[k].d]));
  Object.keys(mDef).sort((a,b)=>mDef[b]-mDef[a]).slice(0,5).forEach(k=>dA.push([k,mDef[k],mDef[k]]));
  new google.visualization.ColumnChart(document.getElementById('dash_chart_model')).draw(google.visualization.arrayToDataTable(mA), {title:'Top Models', legend:'none', colors:['#002060']});
  new google.visualization.ColumnChart(document.getElementById('dash_chart_defect')).draw(google.visualization.arrayToDataTable(dA), {title:'Top Defects', legend:'none', colors:['#dc3545']});
}

function editRow(idx, r){
  showPage('entry'); document.getElementById('e_date').value=r[0]; document.getElementById('e_shift').value=r[8]||'A';
  document.getElementById('e_line').value=r[1]; document.getElementById('e_model').value=r[2];
  document.getElementById('e_input').value=r[3]; document.getElementById('e_prep').value=r[6];
  document.getElementById('edit_sheet_name').value=r[9]; document.getElementById('edit_index').value=r[10];
  document.getElementById('defect_wrapper').innerHTML="";
  try{ JSON.parse(r[7]).forEach(d=>addDefectRow(d)); }catch(e){ addDefectRow(); } calcTotal();
}

// --- REPORTS ---
function makeEditable(id) {
    document.querySelectorAll(`#${id} .analysis-item p`).forEach(p => {
        p.contentEditable = "true"; p.style.borderBottom = "1px dashed #ccc"; p.title = "Click to Edit";
    });
}

function genReport(){
  let s = document.getElementById('r_date_start').value, e = document.getElementById('r_date_end').value;
  let rData = currentData.filter(r => r[0] >= s && r[0] <= e);
  document.getElementById('print_area').style.display = 'block';
  document.getElementById('r_subtitle').innerText = `${s} to ${e}`;
  processReportData(rData, 'r_inp', 'r_def', 'r_rate_val', 'trend_chart_div', 'pareto_chart_div', 'analysis_list', 'remaining_list', 'model_chart_div');
  makeEditable('analysis_list');
}

function genModelReport(){
    let s = document.getElementById('m_date_start').value, e = document.getElementById('m_date_end').value;
    let selectedModels = [];
    document.querySelectorAll('#checkboxes input:checked').forEach(c => selectedModels.push(c.value));
    if(selectedModels.length === 0) return alert("Select at least one model");

    document.getElementById('m_name_disp').innerText = selectedModels.join(", ");
    document.getElementById('m_subtitle').innerText = `${s} to ${e}`;
    let rData = currentData.filter(r => r[0] >= s && r[0] <= e && selectedModels.includes(r[2]));
    document.getElementById('model_print_area').style.display = 'block';
    processReportData(rData, 'm_inp', 'm_def', 'm_rate_val', 'm_trend_chart', 'm_pareto_chart', 'm_analysis_list', 'm_remaining_list');
    makeEditable('m_analysis_list');
}

function genDefectWiseReport(){
    let s = document.getElementById('d_date_start').value, e = document.getElementById('d_date_end').value;
    let def = document.getElementById('d_defect_select').value;
    document.getElementById('d_name_disp').innerText = def;
    document.getElementById('d_subtitle').innerText = `${s} to ${e}`;
    let rData = currentData.filter(r => r[0] >= s && r[0] <= e);
    let mStats = {}, totQty = 0, anaList = [];
    
    rData.forEach(r => {
        try { JSON.parse(r[7]).forEach(d => {
            if(d.name === def) {
                let q = +d.qty; totQty += q;
                if(!mStats[r[2]]) mStats[r[2]] = {i:0, q:0};
                mStats[r[2]].i += (+r[3]); mStats[r[2]].q += q;
                if(d.analysis) anaList.push({m:r[2], a:d.analysis, ac:d.action});
            }
        }); } catch(e){}
    });
    
    document.getElementById('d_tot_qty').innerText = totQty;
    document.getElementById('d_aff_models').innerText = Object.keys(mStats).length;
    let chartData = [['Model', 'Qty', {role:'annotation'}]], tblHtml = "";
    Object.keys(mStats).sort((a,b)=>mStats[b].q-mStats[a].q).forEach(m => {
        chartData.push([m, mStats[m].q, mStats[m].q]);
        tblHtml += `<tr><td>${m}</td><td>${mStats[m].i}</td><td><b>${mStats[m].q}</b></td><td>${(mStats[m].q/mStats[m].i*100).toFixed(2)}%</td></tr>`;
    });
    document.getElementById('defect_detail_body').innerHTML = tblHtml;
    document.getElementById('d_analysis_list').innerHTML = anaList.map(x => `<div class="analysis-item"><h5>${x.m}</h5><p contenteditable="true">${x.a}</p></div>`).join("");
    document.getElementById('defect_print_area').style.display='block';
    chartInstances['Defect'] = new google.visualization.ColumnChart(document.getElementById('d_contrib_chart'));
    chartInstances['Defect'].draw(google.visualization.arrayToDataTable(chartData), {legend:'none', colors:['#E36C09']});
}

function genMonthReport() {
    let mo = document.getElementById('mo_picker').value; 
    if(!mo) return alert("Select Month");
    let rData = currentData.filter(r => r[0].startsWith(mo));
    document.getElementById('month_report').style.display = 'block';
    document.getElementById('month_print_area').style.display = 'block';
    document.getElementById('mo_subtitle').innerText = "Month: " + mo;
    
    processReportData(rData, 'mo_inp', 'mo_def', 'mo_rate', 'mo_trend_chart', 'mo_pareto_chart', 'mo_analysis_list', null, 'mo_model_chart');
    makeEditable('mo_analysis_list');
    
    chartInstances['Month_Trend'] = new google.visualization.LineChart(document.getElementById('mo_trend_chart'));
    chartInstances['Month_Model'] = new google.visualization.ColumnChart(document.getElementById('mo_model_chart'));
    chartInstances['Month_Pareto'] = new google.visualization.ColumnChart(document.getElementById('mo_pareto_chart'));
}

function processReportData(rData, inpId, defId, rateId, trendId, paretoId, anaId, remId, modelChartId){
  let totInp=0, totDef=0, dateMap = {}, modelMap = {}, defectsMap = {};
  rData.forEach(r => {
    let d = r[0], inp = +r[3], df = +r[4]; totInp += inp; totDef += df;
    if(!dateMap[d]) dateMap[d] = {i:0, d:0}; dateMap[d].i += inp; dateMap[d].d += df;
    if(modelChartId) { if(!modelMap[r[2]]) modelMap[r[2]] = {i:0, d:0}; modelMap[r[2]].i += inp; modelMap[r[2]].d += df; }
    try { JSON.parse(r[7]).forEach(item => {
        let n = item.name; if(!defectsMap[n]) defectsMap[n] = {qty:0, anaList:[]};
        defectsMap[n].qty += (+item.qty); if(item.analysis) defectsMap[n].anaList.push(item.analysis);
    }); } catch(e){}
  });

  document.getElementById(inpId).innerText = totInp; document.getElementById(defId).innerText = totDef;
  document.getElementById(rateId).innerText = totInp>0 ? (totDef/totInp*100).toFixed(2)+"%" : "0.00%";

  let tData = [['Date', 'Rej %', {role:'annotation'}]];
  Object.keys(dateMap).sort().forEach(k => { let v = dateMap[k].i>0?dateMap[k].d/dateMap[k].i*100:0; tData.push([k, v, v.toFixed(1)+'%']); });
  let tChart = new google.visualization.LineChart(document.getElementById(trendId));
  tChart.draw(google.visualization.arrayToDataTable(tData), {title:'Rejection Trend', legend:'none', pointSize:5, colors:['#002060']});
  if(trendId === 'mo_trend_chart') chartInstances['mo_trend'] = tChart;

  if(modelChartId) {
      let mData = [['Model', 'Defects', {role:'annotation'}]];
      Object.keys(modelMap).sort((a,b)=>modelMap[b].d-modelMap[a].d).slice(0,10).forEach(m=>mData.push([m, modelMap[m].d, modelMap[m].d]));
      let mChart = new google.visualization.ColumnChart(document.getElementById(modelChartId));
      mChart.draw(google.visualization.arrayToDataTable(mData), {title:'Top Models', legend:'none', colors:['#218838']});
      if(modelChartId === 'mo_model_chart') chartInstances['mo_model'] = mChart;
  }

  let sDef = Object.keys(defectsMap).map(k=>({n:k, ...defectsMap[k]})).sort((a,b)=>b.qty-a.qty);
  if(paretoId){
      let pData = [['Defect', 'Qty', {role:'annotation'}]];
      sDef.slice(0,10).forEach(s=>pData.push([s.n, s.qty, s.qty]));
      let pChart = new google.visualization.ColumnChart(document.getElementById(paretoId));
      pChart.draw(google.visualization.arrayToDataTable(pData), {title:'Defect Pareto', legend:'none', colors:['#dc3545']});
      if(paretoId === 'mo_pareto_chart') chartInstances['mo_pareto'] = pChart;
  }

  if(anaId){
      document.getElementById(anaId).innerHTML = sDef.slice(0,5).map(s => `<div class="analysis-item"><div><h5>${s.n} (Qty: ${s.qty})</h5><p class="editable">${[...new Set(s.anaList)].join(', ') || 'No Analysis'}</p></div></div>`).join("");
  }
  if(remId){
      document.getElementById(remId).innerHTML = sDef.slice(5).map(s => `<tr><td>${s.n}</td><td>${s.qty}</td><td>${(s.qty/totInp*100).toFixed(2)}%</td></tr>`).join("");
  }
}

// --- EXPORTS ---
function downloadPDF(id, name){
    let opt = { margin: 10, filename: name, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
    html2pdf().from(document.getElementById(id)).set(opt).save();
}

function downloadProfessionalPPT(type) {
    let pptx = new PptxGenJS();
    pptx.layout = 'LAYOUT_WIDE';
    
    // SLIDE 1: Title (WITH LOGO)
    let s1 = pptx.addSlide();
    s1.addImage({ path: LOGO_URL, x: 0.5, y: 0.3, w: 2, h: 0.8 });
    s1.background = { color: "F1F1F1" };
    s1.addText("Califonix Systems", { x: 0.5, y: 1.5, fontSize: 32, color: "002060", bold: true });
    s1.addText(type + " Analysis Report", { x: 0.5, y: 2.5, fontSize: 24, color: "333333" });
    s1.addText("Generated on: " + new Date().toDateString(), { x: 0.5, y: 3.5, fontSize: 14, color: "666666" });

    // SLIDE 2: Statistics (WITH LOGO)
    let s2 = pptx.addSlide();
    s2.addImage({ path: LOGO_URL, x: 11, y: 0.3, w: 1.5, h: 0.6 });
    s2.addText("Performance Overview", { x: 0.5, y: 0.5, fontSize: 20, color: "002060", bold:true });
    
    if(type === 'Month') {
        let inp = document.getElementById('mo_inp').innerText;
        let def = document.getElementById('mo_def').innerText;
        let rate = document.getElementById('mo_rate').innerText;
        
        s2.addShape(pptx.ShapeType.rect, { x: 1, y: 1.5, w: 3, h: 2, fill: "FFFFFF", line: {color:"002060", width:2} });
        s2.addText("Total Input", { x: 1, y: 2, w: 3, align: 'center', fontSize: 14 });
        s2.addText(inp, { x: 1, y: 2.5, w: 3, align: 'center', fontSize: 32, bold: true, color: "002060" });

        s2.addShape(pptx.ShapeType.rect, { x: 5, y: 1.5, w: 3, h: 2, fill: "FFFFFF", line: {color:"DC3545", width:2} });
        s2.addText("Total Defects", { x: 5, y: 2, w: 3, align: 'center', fontSize: 14 });
        s2.addText(def, { x: 5, y: 2.5, w: 3, align: 'center', fontSize: 32, bold: true, color: "DC3545" });

        s2.addShape(pptx.ShapeType.rect, { x: 9, y: 1.5, w: 3, h: 2, fill: "FFFFFF", line: {color:"E36C09", width:2} });
        s2.addText("Rejection Rate", { x: 9, y: 2, w: 3, align: 'center', fontSize: 14 });
        s2.addText(rate, { x: 9, y: 2.5, w: 3, align: 'center', fontSize: 32, bold: true, color: "E36C09" });

        // SLIDE 3: Charts
        let s3 = pptx.addSlide();
        s3.addImage({ path: LOGO_URL, x: 11, y: 0.3, w: 1.5, h: 0.6 });
        s3.addText("Trend & Pareto Analysis", { x: 0.5, y: 0.5, fontSize: 18, color: "002060" });
        try { if(chartInstances['mo_trend']) s3.addImage({ data: chartInstances['mo_trend'].getImageURI(), x: 0.5, y: 1, w: 6, h: 3 }); } catch(e){}
        try { if(chartInstances['mo_pareto']) s3.addImage({ data: chartInstances['mo_pareto'].getImageURI(), x: 7, y: 1, w: 6, h: 3 }); } catch(e){}
        
        // SLIDE 4: Model Analysis
        let s4 = pptx.addSlide();
        s4.addImage({ path: LOGO_URL, x: 11, y: 0.3, w: 1.5, h: 0.6 });
        s4.addText("Model Wise Breakdown", { x: 0.5, y: 0.5, fontSize: 18, color: "002060" });
        try { if(chartInstances['mo_model']) s4.addImage({ data: chartInstances['mo_model'].getImageURI(), x: 1, y: 1.5, w: 11, h: 4 }); } catch(e){}

    } else if (type === 'Defect') {
        let s3 = pptx.addSlide();
        s3.addImage({ path: LOGO_URL, x: 11, y: 0.3, w: 1.5, h: 0.6 });
        s3.addText("Defect Contribution", { x: 0.5, y: 0.5, fontSize: 18, color: "002060" });
        try { if(chartInstances['Defect']) s3.addImage({ data: chartInstances['Defect'].getImageURI(), x: 1, y: 1.5, w: 10, h: 4 }); } catch(e){}
    }

    pptx.writeFile({ fileName: `Califonix_${type}_Report.pptx` });
}
</script>
</body>
</html>
