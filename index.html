<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMT Master Dashboard</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
  .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  
  /* Buttons & Nav */
  .nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
  button { padding: 10px 15px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; }
  .btn-blue { background: #007bff; color: white; }
  .btn-green { background: #28a745; color: white; }
  .btn-gray { background: #6c757d; color: white; }
  .btn-red { background: #dc3545; color: white; padding: 5px 10px; font-size: 12px;}
  .btn-info { background: #17a2b8; color: white; padding: 5px 10px; font-size: 12px; }

  /* Forms */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
  label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px; }
  input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;}
  input[readonly] { background-color: #e9ecef; color: #495057; font-weight: bold; }

  /* Defect Rows */
  .defect-row { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: #f9f9f9; display: grid; grid-template-columns: 2fr 1fr 1fr 2fr 1fr 0.5fr; gap: 10px; align-items: end; }
  .img-preview { height: 40px; display: none; margin-top: 5px; border: 1px solid #ccc; }

  /* Dashboard */
  .kpi-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;}
  .kpi-card { flex: 1; min-width: 150px; background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center; border-left: 5px solid #007bff; }
  .kpi-val { font-size: 24px; font-weight: bold; margin-top: 5px; }

  /* Report */
  .report-box { border: 1px solid #000; padding: 20px; display: none; margin-top: 20px; }
  .analysis-item { display: flex; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; gap: 15px; }
  .analysis-img { width: 100px; height: 100px; object-fit: contain; border: 1px solid #eee; }

  /* MODAL (Popup) */
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); }
  .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; }
  .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; }
  .close { font-size: 28px; font-weight: bold; cursor: pointer; }
  
  /* Loader */
  #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1001; text-align: center; padding-top: 200px; font-size: 20px; font-weight: bold; color: #007bff; }
</style>
</head>
<body>

<div id="loader">Processing... Please Wait...</div>

<!-- PREVIEW MODAL -->
<div id="previewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 style="margin:0">üìÑ Record Details Preview</h3>
      <span class="close" onclick="closeModal()">&times;</span>
    </div>
    <div id="previewBody"></div>
    <div style="margin-top:20px; text-align:right; border-top:1px solid #eee; padding-top:10px;" id="previewFooter"></div>
  </div>
</div>

<div class="container">
  <h2 style="text-align:center; color:#333;">üè≠ SMT Master Dashboard</h2>

  <div class="nav">
    <button class="btn-blue" onclick="showPage('dashboard')">Dashboard</button>
    <button class="btn-gray" onclick="showPage('entry')">Data Entry</button>
    <button class="btn-green" onclick="showPage('report')">Analysis Report</button>
  </div>

  <!-- DASHBOARD PAGE -->
  <div id="dashboard">
    <div class="form-grid">
      <div><label>From</label><input type="date" id="dash_from"></div>
      <div><label>To</label><input type="date" id="dash_to"></div>
      <div style="display:flex; align-items:end;"><button class="btn-blue" onclick="loadData()">Filter Data</button></div>
    </div>

    <div class="kpi-container">
       <div class="kpi-card"><div>Overall Rejection</div><div class="kpi-val" id="k_all">0%</div></div>
       <div class="kpi-card" style="border-color:#28a745; background:#e8f5e9;"><div>Floor 1</div><div class="kpi-val" id="k_f1">0%</div></div>
       <div class="kpi-card" style="border-color:#ff9800; background:#fff3e0;"><div>Floor 2</div><div class="kpi-val" id="k_f2">0%</div></div>
       <div class="kpi-card" style="border-color:#6f42c1; background:#f3e5f5;"><div>Basement</div><div class="kpi-val" id="k_fb">0%</div></div>
    </div>

    <div style="overflow-x:auto;">
      <table border="1" style="width:100%; border-collapse:collapse; border-color:#ddd;">
        <thead><tr style="background:#f1f1f1;"><th>Date</th><th>Line</th><th>Model</th><th>Input</th><th>Defects</th><th>Rej %</th><th>Action</th></tr></thead>
        <tbody id="dash_table"></tbody>
      </table>
    </div>
  </div>

  <!-- ENTRY PAGE -->
  <div id="entry" style="display:none;">
    <h3>üìù Add / Edit Record</h3>
    <input type="hidden" id="edit_index">
    
    <div class="form-grid">
      <div><label>Date</label><input type="date" id="e_date"></div>
      <div><label>Line</label><input type="number" id="e_line" placeholder="1-24"></div>
      <div><label>Model</label><input type="text" id="e_model"></div>
      <div><label>Input Qty</label><input type="number" id="e_input" oninput="calcTotal()"></div>
      <div><label>Prepared By</label><input type="text" id="e_prep"></div>
    </div>

    <h4>Defect Details</h4>
    <div id="defect_wrapper"></div>
    <button class="btn-gray" onclick="addDefectRow()">+ Add Defect</button>

    <div style="margin-top:20px; padding:15px; background:#e3f2fd; border-radius:8px; border:1px solid #90caf9;">
       <h4 style="margin-top:0;">Summary</h4>
       <div class="form-grid">
           <div><label>Total Defect Qty</label><input type="text" id="lbl_tot" readonly></div>
           <div><label>Overall Defect Rate %</label><input type="text" id="lbl_rate" readonly style="color:red; font-size:16px;"></div>
           <div style="display:flex; align-items:end;">
             <button class="btn-blue" onclick="previewEntry()" style="width:100%;">üëÅÔ∏è PREVIEW & SAVE</button>
           </div>
       </div>
    </div>
  </div>

  <!-- REPORT PAGE -->
  <div id="report" style="display:none;">
    <div class="form-grid no-print">
      <div><label>From Date</label><input type="date" id="r_date_start"></div>
      <div><label>To Date</label><input type="date" id="r_date_end"></div>
      <div style="display:flex; align-items:end; gap:10px;">
        <button class="btn-blue" onclick="genReport()">Generate</button>
        <button class="btn-green" onclick="downloadPDF()">Download PDF</button>
      </div>
    </div>

    <div id="print_area" class="report-box">
      <h2 style="text-align:center;">SMT QUALITY ANALYSIS REPORT</h2>
      <p style="text-align:center;" id="r_subtitle">--</p>
      
      <table style="width:100%; border:1px solid #000; margin-bottom:20px; text-align:center;">
        <tr>
          <td style="padding:10px;"><b>Total Input:</b> <span id="r_inp">0</span></td>
          <td style="padding:10px;"><b>Total Defect:</b> <span id="r_def">0</span></td>
          <td style="padding:10px;"><b>Rejection Rate:</b> <span id="r_rate_val">0%</span></td>
        </tr>
      </table>

      <h4>üèÜ Top 5 Defects Contribution</h4>
      <div id="chart_div" style="width:100%; height:300px;"></div>

      <h4>üîç Detailed Analysis</h4>
      <div id="analysis_list"></div>
    </div>
  </div>

</div>

<script>
// ‚ö†Ô∏è YAHAN APNA URL UPDATE KAREIN
const API_URL = "https://script.google.com/macros/s/AKfycbzkn_YQtnDPW47OTPt9ZlASfj66JMmYdGjbCOvhVL3mwXvfERdtFY761KDqut88dv42FQ/exec";

let allData = [];
google.charts.load('current', {'packages':['corechart']});

window.onload = () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('e_date').value = today;
  document.getElementById('dash_from').value = today;
  addDefectRow();
  loadData();
};

function showPage(id){
  document.querySelectorAll('#dashboard, #entry, #report').forEach(d => d.style.display='none');
  document.getElementById(id).style.display='block';
}

/* --- HELPER: FORMAT PERCENTAGE (The Fix) --- */
function formatPct(val) {
    let s = String(val);
    if(s.includes("%")) return s; // Already correct
    
    // If decimal like 0.001 or 0.0222, convert to %
    let n = parseFloat(s);
    if(isNaN(n)) return "0.00%";
    
    // Multipling by 100 to fix decimal issue
    return (n * 100).toFixed(2) + "%";
}

// --- DATA ENTRY ---
function addDefectRow(data = null){
  const div = document.createElement('div');
  div.className = 'defect-row';
  div.innerHTML = `
    <div><label>Defect Name</label><input class="d-name" placeholder="Name"></div>
    <div><label>Qty</label><input type="number" class="d-qty" oninput="calcTotal()" placeholder="0"></div>
    <div><label>Defect %</label><input class="d-rate" readonly placeholder="%"></div>
    <div><label>Analysis</label><input class="d-ana" placeholder="Cause"></div>
    <div><label>Image</label><input type="file" accept="image/*" onchange="handleImg(this)"></div>
    <div style="text-align:center;">
      <img class="img-preview">
      <input type="hidden" class="d-base64">
      <button class="btn-red" onclick="this.parentElement.parentElement.remove(); calcTotal()">X</button>
    </div>
  `;
  document.getElementById('defect_wrapper').appendChild(div);

  if(data){
    div.querySelector('.d-name').value = data.name;
    div.querySelector('.d-qty').value = data.qty;
    div.querySelector('.d-rate').value = formatPct(data.rate || 0);
    div.querySelector('.d-ana').value = data.analysis;
    if(data.image) {
       div.querySelector('.img-preview').src = data.image;
       div.querySelector('.img-preview').style.display = 'block';
       div.querySelector('.d-base64').value = data.image;
    }
  }
}

function handleImg(input){
  if(input.files && input.files[0]){
    const reader = new FileReader();
    reader.onload = (e) => {
      let img = new Image();
      img.onload = () => {
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        let w = img.width, h = img.height;
        if(w>600){ h *= 600/w; w=600; } 
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        let base64 = canvas.toDataURL('image/jpeg', 0.6);
        let row = input.closest('.defect-row');
        row.querySelector('.img-preview').src = base64;
        row.querySelector('.img-preview').style.display='block';
        row.querySelector('.d-base64').value = base64;
      }
      img.src = e.target.result;
    }
    reader.readAsDataURL(input.files[0]);
  }
}

function calcTotal(){
  let inp = +document.getElementById('e_input').value || 0;
  let tot = 0;
  document.querySelectorAll('.d-qty').forEach(i => tot += (+i.value||0));
  
  document.getElementById('lbl_tot').value = tot;
  
  // Calculate Overall %
  let overallPct = inp > 0 ? (tot/inp*100).toFixed(2)+"%" : "0.00%";
  document.getElementById('lbl_rate').value = overallPct;

  // Calculate Row %
  document.querySelectorAll('.defect-row').forEach(row => {
     let qty = +row.querySelector('.d-qty').value || 0;
     let rateBox = row.querySelector('.d-rate');
     rateBox.value = (inp > 0 && qty > 0) ? (qty / inp * 100).toFixed(2) + "%" : "0%";
  });
}

// --- PREVIEW & SAVE ---
function previewEntry() {
    let data = {
        date: document.getElementById('e_date').value,
        line: document.getElementById('e_line').value,
        model: document.getElementById('e_model').value,
        input: document.getElementById('e_input').value,
        total: document.getElementById('lbl_tot').value,
        rate: document.getElementById('lbl_rate').value, // This is already formatted by calcTotal
        prep: document.getElementById('e_prep').value,
        defects: []
    };

    if(!data.input || !data.line) return alert("Please fill Line and Input Qty");

    document.querySelectorAll('.defect-row').forEach(row => {
        data.defects.push({
            name: row.querySelector('.d-name').value,
            qty: row.querySelector('.d-qty').value,
            rate: row.querySelector('.d-rate').value,
            ana: row.querySelector('.d-ana').value,
            img: row.querySelector('.d-base64').value
        });
    });

    let html = `
        <table style="width:100%; border-collapse:collapse; border:1px solid #ddd; margin-bottom:10px;">
            <tr><td><b>Date:</b> ${data.date}</td><td><b>Line:</b> ${data.line}</td><td><b>Model:</b> ${data.model}</td></tr>
            <tr><td><b>Input:</b> ${data.input}</td><td><b>Total Defects:</b> ${data.total}</td><td><b>Rej %:</b> <span style="color:red; font-weight:bold">${data.rate}</span></td></tr>
            <tr><td colspan="3"><b>Prepared By:</b> ${data.prep}</td></tr>
        </table>
        <h4>Defects List:</h4>
        <table border="1" style="width:100%; border-collapse:collapse; font-size:12px; text-align:center;">
            <tr style="background:#eee;"><th>Name</th><th>Qty</th><th>%</th><th>Analysis</th><th>Image</th></tr>
    `;

    data.defects.forEach(d => {
        let imgTag = d.img ? `<img src="${d.img}" style="height:40px;">` : '-';
        html += `<tr><td>${d.name}</td><td>${d.qty}</td><td>${d.rate}</td><td>${d.ana}</td><td>${imgTag}</td></tr>`;
    });
    html += `</table>`;

    document.getElementById('previewBody').innerHTML = html;
    document.getElementById('previewFooter').innerHTML = `
        <button class="btn-gray" onclick="closeModal()">Edit</button>
        <button class="btn-green" onclick="saveData()">‚úÖ Confirm & Save</button>
    `;
    document.getElementById('previewModal').style.display = "block";
}

function viewRecord(idx, r) {
    let list = [];
    try { list = JSON.parse(r[7]); } catch(e){}

    // Fix Rej % display using helper
    let displayRate = formatPct(r[5]);

    let html = `
        <table style="width:100%; border-collapse:collapse; border:1px solid #ddd; margin-bottom:10px;">
            <tr><td><b>Date:</b> ${r[0]}</td><td><b>Line:</b> ${r[1]}</td><td><b>Model:</b> ${r[2]}</td></tr>
            <tr><td><b>Input:</b> ${r[3]}</td><td><b>Total Defects:</b> ${r[4]}</td><td><b>Rej %:</b> <span style="color:red; font-weight:bold">${displayRate}</span></td></tr>
            <tr><td colspan="3"><b>Prepared By:</b> ${r[6]}</td></tr>
        </table>
        <h4>Defects List:</h4>
        <table border="1" style="width:100%; border-collapse:collapse; font-size:12px; text-align:center;">
            <tr style="background:#eee;"><th>Name</th><th>Qty</th><th>%</th><th>Analysis</th><th>Image</th></tr>
    `;

    list.forEach(d => {
        let imgTag = d.image ? `<img src="${d.image}" style="height:50px;">` : '-';
        // Ensure defect rate is formatted
        let dRate = formatPct(d.rate || 0);
        html += `<tr><td>${d.name}</td><td>${d.qty}</td><td>${dRate}</td><td>${d.analysis}</td><td>${imgTag}</td></tr>`;
    });
    html += `</table>`;

    document.getElementById('previewBody').innerHTML = html;
    document.getElementById('previewFooter').innerHTML = `<button class="btn-gray" onclick="closeModal()">Close</button>`;
    document.getElementById('previewModal').style.display = "block";
}

function closeModal() { document.getElementById('previewModal').style.display = "none"; }

async function saveData(){
  if(!API_URL.includes("script.google.com")){ alert("Please setup API URL in code first!"); return; }
  closeModal(); 
  document.getElementById('loader').style.display = 'block';
  
  let defects = [];
  document.querySelectorAll('.defect-row').forEach(row => {
    defects.push({
      name: row.querySelector('.d-name').value,
      qty: row.querySelector('.d-qty').value,
      rate: row.querySelector('.d-rate').value,
      analysis: row.querySelector('.d-ana').value,
      image: row.querySelector('.d-base64').value
    });
  });

  let payload = {
    action: "save",
    rowIndex: document.getElementById('edit_index').value,
    date: document.getElementById('e_date').value,
    line: document.getElementById('e_line').value,
    model: document.getElementById('e_model').value,
    input: document.getElementById('e_input').value,
    totalDef: document.getElementById('lbl_tot').value,
    rejRate: document.getElementById('lbl_rate').value, // Sending String "0.10%"
    prep: document.getElementById('e_prep').value,
    defects: defects
  };

  try {
    await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
    alert("‚úÖ Data Saved Successfully!");
    location.reload();
  } catch(e) {
    alert("‚ùå Error saving data");
  } finally {
    document.getElementById('loader').style.display = 'none';
  }
}

// --- DASHBOARD LOAD ---
async function loadData(){
  try {
    let res = await fetch(API_URL);
    let json = await res.json();
    allData = json.data;
    renderDash();
  } catch(e) { console.log("Load Error", e); }
}

function renderDash(){
  let from = document.getElementById('dash_from').value;
  let to = document.getElementById('dash_to').value || from;
  let tBody = document.getElementById('dash_table');
  tBody.innerHTML = "";

  let stats = { all_i:0, all_d:0, f1_i:0, f1_d:0, f2_i:0, f2_d:0, fb_i:0, fb_d:0 };

  allData.forEach((r, idx) => {
    if(r[0] < from || r[0] > to) return;

    let line = +r[1]; let inp = +r[3]; let def = +r[4];
    stats.all_i += inp; stats.all_d += def;
    
    if(line<=8) { stats.f1_i+=inp; stats.f1_d+=def; }
    else if(line<=16) { stats.f2_i+=inp; stats.f2_d+=def; }
    else { stats.fb_i+=inp; stats.fb_d+=def; }

    // --- FIX: DISPLAY CORRECT PERCENTAGE ---
    let displayRej = formatPct(r[5]); // Using helper to fix 0.001 -> 0.10%

    // Color logic
    let valStr = displayRej.replace("%", ""); 
    let valNum = parseFloat(valStr);
    let color = valNum > 0 ? (valNum > 1 ? 'red' : '#e65100') : 'green';

    tBody.innerHTML += `
      <tr>
        <td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${inp}</td>
        <td>${r[4]}</td>
        <td style="color:${color}; font-weight:bold;">${displayRej}</td>
        <td>
           <button class="btn-info" onclick='viewRecord(${idx}, ${JSON.stringify(r)})'>üëÅÔ∏è View</button>
           <button class="btn-blue" style="font-size:10px;" onclick='editRow(${idx}, ${JSON.stringify(r)})'>‚úèÔ∏è</button>
           <button class="btn-red" style="font-size:10px;" onclick="delRow(${idx})">üóëÔ∏è</button>
        </td>
      </tr>
    `;
  });

  const rate = (d,i) => i>0 ? (d/i*100).toFixed(2)+"%" : "0.00%";
  document.getElementById('k_all').innerText = rate(stats.all_d, stats.all_i);
  document.getElementById('k_f1').innerText = rate(stats.f1_d, stats.f1_i);
  document.getElementById('k_f2').innerText = rate(stats.f2_d, stats.f2_i);
  document.getElementById('k_fb').innerText = rate(stats.fb_d, stats.fb_i);
}

function editRow(idx, r){
  showPage('entry');
  document.getElementById('edit_index').value = idx;
  document.getElementById('e_date').value = r[0];
  document.getElementById('e_line').value = r[1];
  document.getElementById('e_model').value = r[2];
  document.getElementById('e_input').value = r[3];
  document.getElementById('e_prep').value = r[6];
  
  document.getElementById('defect_wrapper').innerHTML = "";
  try {
    let list = JSON.parse(r[7]);
    list.forEach(d => addDefectRow(d));
  } catch(e) { addDefectRow(); }
  calcTotal();
}

async function delRow(idx){
  if(!confirm("Delete this record?")) return;
  document.getElementById('loader').style.display='block';
  await fetch(API_URL, { method:"POST", body:JSON.stringify({action:"delete", rowIndex:idx}) });
  location.reload();
}

// --- REPORT ---
function genReport(){
  let start = document.getElementById('r_date_start').value;
  let end = document.getElementById('r_date_end').value;
  if(!start) return alert("Select Start Date");
  if(!end) end = start; 
  
  document.getElementById('print_area').style.display = 'block';
  document.getElementById('r_subtitle').innerText = `Period: ${start} to ${end}`;

  let rData = allData.filter(r => r[0] >= start && r[0] <= end);
  if(rData.length === 0) { alert("No data"); document.getElementById('print_area').style.display = 'none'; return; }

  let totInp=0, totDef=0;
  let defectsMap = {};

  rData.forEach(r => {
    totInp += (+r[3]); totDef += (+r[4]);
    try {
      let list = JSON.parse(r[7]);
      list.forEach(d => {
        let name = d.name || "Unknown";
        if(!defectsMap[name]) defectsMap[name] = {qty:0, imgs:[], ana:[]};
        defectsMap[name].qty += (+d.qty);
        if(d.image && defectsMap[name].imgs.length<3) defectsMap[name].imgs.push(d.image);
        if(d.analysis) defectsMap[name].ana.push(d.analysis);
      });
    } catch(e){}
  });

  document.getElementById('r_inp').innerText = totInp;
  document.getElementById('r_def').innerText = totDef;
  document.getElementById('r_rate_val').innerText = totInp>0 ? (totDef/totInp*100).toFixed(2)+"%" : "0.00%";

  let chartData = [['Defect', 'Qty']];
  let sorted = Object.keys(defectsMap).map(k=>({name:k, ...defectsMap[k]})).sort((a,b)=>b.qty-a.qty).slice(0,5);
  sorted.forEach(s => chartData.push([s.name, s.qty]));
  
  if(sorted.length > 0){
     let chart = new google.visualization.PieChart(document.getElementById('chart_div'));
     chart.draw(google.visualization.arrayToDataTable(chartData), {title:'Top 5 Defects', is3D:true});
  } else { document.getElementById('chart_div').innerHTML = "No Defects"; }

  let html = "";
  sorted.forEach(s => {
    let imgs = s.imgs.map(u => `<img src="${u}" class="analysis-img">`).join("");
    let ana = [...new Set(s.ana)].join(", ");
    let defRate = totInp > 0 ? (s.qty / totInp * 100).toFixed(2) + "%" : "0.00%";
    
    html += `
      <div class="analysis-item">
        <div style="flex:1">
           <h4>${s.name}</h4>
           <p><b>Qty:</b> ${s.qty} | <b>Contribution:</b> ${defRate}</p>
           <p><b>Analysis:</b> ${ana}</p>
        </div>
        <div>${imgs}</div>
      </div>
    `;
  });
  document.getElementById('analysis_list').innerHTML = html;
}

function downloadPDF(){
  const el = document.getElementById('print_area');
  html2pdf().set({margin:0.5, filename:'Report.pdf', image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'in', format:'letter', orientation:'portrait'}}).from(el).save();
}

</script>
</body>
</html>
