<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMT Master Dashboard</title>
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
  
  /* --- MAIN HEADER --- */
  .main-header { display: flex; align-items: center; background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; max-width: 1200px; margin-left: auto; margin-right: auto; }
  .main-logo { height: 50px; margin-right: 20px; }
  .main-title h2 { margin: 0; color: #003366; }
  .main-title p { margin: 0; color: #666; font-size: 12px; }

  .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  
  /* Navigation */
  .nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; flex-wrap: wrap; }
  button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; transition: 0.2s; }
  button:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-blue { background: #007bff; color: white; }
  .btn-green { background: #28a745; color: white; }
  .btn-gray { background: #6c757d; color: white; }
  .btn-red { background: #dc3545; color: white; padding: 5px 10px; font-size: 12px;}
  .btn-info { background: #17a2b8; color: white; padding: 5px 10px; font-size: 12px; }
  .btn-purple { background: #6f42c1; color: white; }

  /* Forms & Inputs */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px; }
  label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 12px; color: #555; }
  input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; background: #fafafa; }
  input:focus, select:focus { border-color: #007bff; outline: none; background: #fff; }
  input[readonly] { background-color: #e9ecef; color: #495057; font-weight: bold; }

  /* Defect Rows */
  .defect-row { border: 1px solid #e0e0e0; padding: 15px; margin-bottom: 10px; border-radius: 6px; background: #fff; display: grid; grid-template-columns: 2fr 1fr 1fr 2fr 1fr 0.5fr; gap: 10px; align-items: end; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
  .img-preview { height: 40px; display: none; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }

  /* Dashboard KPIs */
  .kpi-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;}
  .kpi-card { flex: 1; min-width: 150px; background: #fff; padding: 20px; border-radius: 8px; text-align: center; border-bottom: 4px solid #007bff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
  .kpi-card div:first-child { color: #888; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
  .kpi-val { font-size: 28px; font-weight: bold; margin-top: 5px; color: #333; }

  /* Report & Charts */
  .report-box { border: 1px solid #ddd; padding: 30px; display: none; margin-top: 20px; background: #fff; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
  
  /* --- CHANGED: Default Chart Row for Dashboard (Side by Side) --- */
  .chart-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
  .chart-box { flex: 1; min-width: 300px; border: 1px solid #eee; padding: 10px; background: #fff; }

  /* --- NEW: Stacked Charts for Reports (One below another) --- */
  .chart-stacked { display: block; width: 100%; margin-bottom: 30px; }
  .chart-full { width: 100%; height: 400px; border: 1px solid #eee; padding: 10px; background: #fff; }
  
  .analysis-item { display: flex; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; gap: 15px; break-inside: avoid; background: #fdfdfd; border-left: 4px solid #007bff; }
  .analysis-img { width: 100px; height: 100px; object-fit: contain; border: 1px solid #eee; background: white; }
  
  .rem-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
  .rem-table th, .rem-table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  .rem-table th { background: #343a40; color: white; }

  /* --- PROFESSIONAL PREVIEW MODAL --- */
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); }
  .modal-content { background-color: #fff; margin: 2% auto; padding: 0; border: none; width: 90%; max-width: 850px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); overflow: hidden; }
  
  /* Preview Header */
  .prev-header { background: #003366; color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; }
  .prev-logo { height: 50px; background: white; padding: 5px; border-radius: 4px; }
  .prev-title h3 { margin: 0; font-size: 20px; text-transform: uppercase; letter-spacing: 1px; }
  .prev-title span { font-size: 12px; opacity: 0.8; }
  .close { color: white; font-size: 28px; font-weight: bold; cursor: pointer; }

  /* Preview Body */
  .prev-body { padding: 25px; }
  
  /* Info Cards in Preview */
  .info-group { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
  .info-box { background: #f8f9fa; padding: 10px; border-radius: 5px; border-left: 4px solid #003366; }
  .info-box span { display: block; font-size: 10px; color: #666; text-transform: uppercase; font-weight: bold; }
  .info-box strong { display: block; font-size: 15px; color: #333; margin-top: 2px; }

  /* Summary Section in Preview */
  .summary-sec { display: flex; justify-content: space-between; background: #e8f0fe; padding: 15px; border-radius: 6px; margin-bottom: 25px; border: 1px solid #b3d7ff; }
  .sum-item { text-align: center; flex: 1; border-right: 1px solid #ccc; }
  .sum-item:last-child { border: none; }
  .sum-lbl { font-size: 11px; font-weight: bold; color: #003366; text-transform: uppercase; }
  .sum-val { font-size: 18px; font-weight: bold; margin-top: 5px; }

  /* Styled Table in Preview */
  .prev-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .prev-table th { background: #343a40; color: white; padding: 10px; text-align: left; text-transform: uppercase; font-size: 11px; }
  .prev-table td { border-bottom: 1px solid #eee; padding: 10px; vertical-align: middle; }
  .prev-table tr:nth-child(even) { background: #f9f9f9; }
  .prev-img { height: 40px; border: 1px solid #ddd; padding: 2px; background: white; }

  .prev-footer { background: #f1f1f1; padding: 15px 25px; text-align: right; border-top: 1px solid #ddd; }
  
  #loader { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1001; text-align: center; padding-top: 200px; font-size: 20px; font-weight: bold; color: #007bff; }
</style>
</head>
<body>

<div id="loader">Processing... Please Wait...</div>

<!-- MAIN PAGE HEADER WITH LOGO -->
<div class="main-header">
    <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="main-logo" alt="Logo">
    <div class="main-title">
        <h2>SMT Master Dashboard</h2>
        <p>Production Quality Control System</p>
    </div>
</div>

<!-- PROFESSIONAL PREVIEW MODAL -->
<div id="previewModal" class="modal">
  <div class="modal-content">
    <!-- Header -->
    <div class="prev-header">
        <div style="display:flex; align-items:center; gap:15px;">
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" class="prev-logo">
            <div class="prev-title">
                <h3>SMT Daily Report</h3>
                <span>SMT Quality Check</span>
            </div>
        </div>
        <span class="close" onclick="closeModal()">&times;</span>
    </div>

    <!-- Body -->
    <div class="prev-body" id="previewBody">
        <!-- Content injected by JS -->
    </div>

    <!-- Footer -->
    <div class="prev-footer" id="previewFooter">
        <!-- Buttons injected by JS -->
    </div>
  </div>
</div>

<div class="container">
  <!-- NAVIGATION -->
  <div class="nav">
    <button class="btn-blue" onclick="showPage('dashboard')">Dashboard</button>
    <button class="btn-gray" onclick="showPage('entry')">Data Entry</button>
    <button class="btn-green" onclick="showPage('report')">Overall Report</button>
    <button class="btn-purple" onclick="showPage('model_report')">Model Report</button>
  </div>

  <!-- 1. DASHBOARD PAGE -->
  <div id="dashboard">
    <div class="form-grid">
      <div><label>From</label><input type="date" id="dash_from"></div>
      <div><label>To</label><input type="date" id="dash_to"></div>
      <div style="display:flex; align-items:end;"><button class="btn-blue" onclick="loadData()">Filter Data</button></div>
    </div>

    <div class="kpi-container">
       <div class="kpi-card"><div>Overall Rejection</div><div class="kpi-val" id="k_all">0%</div></div>
       <div class="kpi-card" style="border-bottom-color:#28a745;"><div>Floor 1</div><div class="kpi-val" id="k_f1">0%</div></div>
       <div class="kpi-card" style="border-bottom-color:#ff9800;"><div>Floor 2</div><div class="kpi-val" id="k_f2">0%</div></div>
       <div class="kpi-card" style="border-bottom-color:#6f42c1;"><div>Basement</div><div class="kpi-val" id="k_fb">0%</div></div>
    </div>

    <!-- DASHBOARD CHARTS (Side by Side) -->
    <div class="chart-row">
        <div class="chart-box" id="dash_chart_model" style="height:350px;"></div>
        <div class="chart-box" id="dash_chart_defect" style="height:350px;"></div>
    </div>

    <div style="overflow-x:auto;">
      <table border="1" style="width:100%; border-collapse:collapse; border-color:#eee; font-size:14px;">
        <thead><tr style="background:#003366; color:white;"><th>Date</th><th>Line</th><th>Model</th><th>Input</th><th>Defects</th><th>Rej %</th><th>Action</th></tr></thead>
        <tbody id="dash_table"></tbody>
      </table>
    </div>
  </div>

  <!-- 2. DATA ENTRY PAGE -->
  <div id="entry" style="display:none;">
    <h3>üìù Add / Edit Record</h3>
    <input type="hidden" id="edit_index">
    
    <div class="form-grid">
      <div><label>Date</label><input type="date" id="e_date"></div>
      <div><label>Line</label><input type="number" id="e_line" placeholder="1-24"></div>
      <div><label>Model</label><input type="text" id="e_model"></div>
      <div><label>Input Qty</label><input type="number" id="e_input" oninput="calcTotal()"></div>
      <div><label>Prepared By</label><input type="text" id="e_prep"></div>
    </div>

    <h4 style="margin-bottom:10px; color:#003366;">Defect Details</h4>
    <div id="defect_wrapper"></div>
    <button class="btn-gray" onclick="addDefectRow()">+ Add Defect</button>

    <div style="margin-top:20px; padding:20px; background:#e8f0fe; border-radius:8px; border:1px solid #b3d7ff;">
       <h4 style="margin-top:0;">Summary</h4>
       <div class="form-grid">
           <div><label>Total Defect Qty</label><input type="text" id="lbl_tot" readonly></div>
           <div><label>Overall Defect Rate %</label><input type="text" id="lbl_rate" readonly style="color:red; font-size:16px;"></div>
           <div style="display:flex; align-items:end;">
             <button class="btn-blue" onclick="previewEntry()" style="width:100%; font-size:16px;">üëÅÔ∏è PREVIEW & SAVE</button>
           </div>
       </div>
    </div>
  </div>

  <!-- 3. OVERALL REPORT PAGE (STACKED LAYOUT) -->
  <div id="report" style="display:none;">
    <div class="form-grid no-print">
      <div><label>From Date</label><input type="date" id="r_date_start"></div>
      <div><label>To Date</label><input type="date" id="r_date_end"></div>
      <div style="display:flex; align-items:end; gap:10px;">
        <button class="btn-blue" onclick="genReport()">Generate</button>
        <button class="btn-green" onclick="downloadPDF('print_area', 'Overall_Report.pdf')">Download PDF</button>
      </div>
    </div>

    <div id="print_area" class="report-box">
      <!-- Report Header -->
      <div style="display:flex; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:20px;">
          <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height:50px;">
          <div style="text-align:right;">
             <h2 style="margin:0;">SMT OVERALL ANALYSIS</h2>
             <p style="margin:0;" id="r_subtitle">--</p>
          </div>
      </div>
      
      <table style="width:100%; border:1px solid #000; margin-bottom:20px; text-align:center;">
        <tr><td style="padding:10px;"><b>Total Input:</b> <span id="r_inp">0</span></td><td style="padding:10px;"><b>Total Defect:</b> <span id="r_def">0</span></td><td style="padding:10px;"><b>Rejection Rate:</b> <span id="r_rate_val">0%</span></td></tr>
      </table>

      <!-- CHARTS STACKED (ONE BY ONE) -->
      <div class="chart-stacked">
        <div class="chart-full" id="trend_chart_div"></div>
      </div>
      
      <div class="chart-stacked">
        <div class="chart-full" id="model_chart_div"></div>
      </div>
      
      <div class="chart-stacked">
         <div class="chart-full" id="pareto_chart_div"></div>
      </div>

      <h4 style="border-bottom:2px solid #333;">üèÜ Top 5 Defects</h4>
      <div id="analysis_list"></div>

      <h4 style="border-bottom:2px solid #333; margin-top:30px;">üìâ Remaining Defects</h4>
      <table class="rem-table"><thead><tr><th>Defect Name</th><th>Qty</th><th>Input (Ref)</th><th>Rate %</th></tr></thead><tbody id="remaining_list"></tbody></table>
    </div>
  </div>

  <!-- 4. MODEL REPORT PAGE (STACKED LAYOUT) -->
  <div id="model_report" style="display:none;">
    <div class="form-grid no-print">
      <div><label>From Date</label><input type="date" id="m_date_start"></div>
      <div><label>To Date</label><input type="date" id="m_date_end"></div>
      <div>
        <label>Select Model</label>
        <select id="m_model_select"><option value="">Loading...</option></select>
      </div>
      <div style="display:flex; align-items:end; gap:10px;">
        <button class="btn-purple" onclick="genModelReport()">Generate View</button>
        <button class="btn-green" onclick="downloadPDF('model_print_area', 'Model_Report.pdf')">PDF</button>
        <button class="btn-info" onclick="downloadExcel()">Excel</button>
      </div>
    </div>

    <div id="model_print_area" class="report-box">
      <!-- Model Report Header -->
      <div style="display:flex; justify-content:space-between; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:20px;">
          <img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height:50px;">
          <div style="text-align:right;">
             <h2 style="margin:0;">MODEL ANALYSIS REPORT</h2>
             <p style="margin:0;" id="m_subtitle">--</p>
          </div>
      </div>
      
      <table style="width:100%; border:1px solid #000; margin-bottom:20px; text-align:center; background:#f8f9fa;">
        <tr>
          <td style="padding:10px;"><b>Selected Model:</b> <span id="m_name_disp" style="color:blue">--</span></td>
          <td style="padding:10px;"><b>Total Input:</b> <span id="m_inp">0</span></td>
          <td style="padding:10px;"><b>Total Defect:</b> <span id="m_def">0</span></td>
          <td style="padding:10px;"><b>Rejection Rate:</b> <span id="m_rate_val" style="color:red">0%</span></td>
        </tr>
      </table>

      <!-- MODEL CHARTS STACKED -->
      <div class="chart-stacked">
        <div class="chart-full" id="m_trend_chart"></div>
      </div>
      
      <div class="chart-stacked">
         <div class="chart-full" id="m_pareto_chart"></div>
      </div>

      <h4 style="border-bottom:2px solid #333;">üèÜ Top 5 Defects (Detailed)</h4>
      <div id="m_analysis_list"></div>

      <h4 style="border-bottom:2px solid #333; margin-top:30px;">üìâ Remaining Defects</h4>
      <table class="rem-table">
          <thead><tr><th>Defect Name</th><th>Qty</th><th>Rate %</th></tr></thead>
          <tbody id="m_remaining_list"></tbody>
      </table>
      
      <table id="excel_table" style="display:none;"><thead><tr><th>Date</th><th>Line</th><th>Model</th><th>Input</th><th>Defect Name</th><th>Qty</th><th>Defect %</th><th>Analysis</th></tr></thead><tbody id="excel_body"></tbody></table>
    </div>
  </div>

</div>

<script>
// ==========================================
// CONFIGURATION
// ==========================================
const API_URL = "https://script.google.com/macros/s/AKfycbzkn_YQtnDPW47OTPt9ZlASfj66JMmYdGjbCOvhVL3mwXvfERdtFY761KDqut88dv42FQ/exec";

const DEFECT_MASTER_LIST = ["Body Sensor Fail","Single LED glow","Channel Fail","SMD Component damaged","DUT Mode Fail","Electric sound","Heating","High Current","Enquiry","LED Not glow","LED Miss","Low current","Secondary MIC Fail","Talk MIC Fail","Not On","POGO Pin shift","Software skip","RF Fail","CTC Fail","Speaker Fail","Scrap","Extra Burr","Mic Distortion"];

let allData = [];
google.charts.load('current', {'packages':['corechart', 'bar']});

window.onload = () => {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('e_date').value = today;
  document.getElementById('dash_from').value = today;
  addDefectRow();
  loadData();
};

function showPage(id){
  document.querySelectorAll('#dashboard, #entry, #report, #model_report').forEach(d => d.style.display='none');
  document.getElementById(id).style.display='block';
}

function formatPct(val) {
    let s = String(val);
    if(s.includes("%")) return s;
    let n = parseFloat(s);
    if(isNaN(n)) return "0.00%";
    return (n * 100).toFixed(2) + "%";
}

// ==========================================
// DATA ENTRY
// ==========================================
function addDefectRow(data = null){
  const div = document.createElement('div');
  div.className = 'defect-row';
  let options = DEFECT_MASTER_LIST.map(d => `<option value="${d}">${d}</option>`).join("");
  div.innerHTML = `
    <div><label>Defect Name</label><select class="d-name"><option value="">Select</option>${options}</select></div>
    <div><label>Qty</label><input type="number" class="d-qty" oninput="calcTotal()" placeholder="0"></div>
    <div><label>Defect %</label><input class="d-rate" readonly placeholder="%"></div>
    <div><label>Analysis</label><input class="d-ana" placeholder="Cause"></div>
    <div><label>Image</label><input type="file" accept="image/*" onchange="handleImg(this)"></div>
    <div style="text-align:center;"><img class="img-preview"><input type="hidden" class="d-base64"><button class="btn-red" onclick="this.parentElement.parentElement.remove(); calcTotal()">X</button></div>
  `;
  document.getElementById('defect_wrapper').appendChild(div);

  if(data){
    div.querySelector('.d-name').value = data.name;
    div.querySelector('.d-qty').value = data.qty;
    div.querySelector('.d-rate').value = formatPct(data.rate || 0);
    div.querySelector('.d-ana').value = data.analysis;
    if(data.image) {
       div.querySelector('.img-preview').src = data.image;
       div.querySelector('.img-preview').style.display = 'block';
       div.querySelector('.d-base64').value = data.image;
    }
  }
}

function handleImg(input){
  if(input.files && input.files[0]){
    const reader = new FileReader();
    reader.onload = (e) => {
      let img = new Image();
      img.onload = () => {
        let canvas = document.createElement('canvas');
        let ctx = canvas.getContext('2d');
        let w = img.width, h = img.height;
        if(w>600){ h *= 600/w; w=600; } 
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        let row = input.closest('.defect-row');
        row.querySelector('.img-preview').src = canvas.toDataURL('image/jpeg', 0.6);
        row.querySelector('.img-preview').style.display='block';
        row.querySelector('.d-base64').value = canvas.toDataURL('image/jpeg', 0.6);
      }
      img.src = e.target.result;
    }
    reader.readAsDataURL(input.files[0]);
  }
}

function calcTotal(){
  let inp = +document.getElementById('e_input').value || 0;
  let tot = 0;
  document.querySelectorAll('.d-qty').forEach(i => tot += (+i.value||0));
  document.getElementById('lbl_tot').value = tot;
  document.getElementById('lbl_rate').value = inp > 0 ? (tot/inp*100).toFixed(2)+"%" : "0.00%";
  document.querySelectorAll('.defect-row').forEach(row => {
     let qty = +row.querySelector('.d-qty').value || 0;
     row.querySelector('.d-rate').value = (inp > 0 && qty > 0) ? (qty / inp * 100).toFixed(2) + "%" : "0%";
  });
}

// --- PREVIEW FUNCTION (BIG FONT 1.5x) ---
function previewEntry() {
    let data = {
        date: document.getElementById('e_date').value,
        line: document.getElementById('e_line').value,
        model: document.getElementById('e_model').value,
        input: document.getElementById('e_input').value,
        total: document.getElementById('lbl_tot').value,
        rate: document.getElementById('lbl_rate').value,
        prep: document.getElementById('e_prep').value,
        defects: []
    };
    if(!data.input || !data.line) return alert("Please fill Line and Input Qty");
    
    document.querySelectorAll('.defect-row').forEach(row => {
        data.defects.push({
            name: row.querySelector('.d-name').value,
            qty: row.querySelector('.d-qty').value,
            rate: row.querySelector('.d-rate').value,
            ana: row.querySelector('.d-ana').value,
            img: row.querySelector('.d-base64').value
        });
    });

    let html = `
        <div style="font-size:16px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px; margin-bottom:10px;">
                <div class="info-box" style="padding:5px;"><span>Date</span><strong style="font-size:16px;">${data.date}</strong></div>
                <div class="info-box" style="padding:5px;"><span>Line</span><strong style="font-size:16px;">${data.line}</strong></div>
                <div class="info-box" style="padding:5px;"><span>Model</span><strong style="font-size:16px;">${data.model}</strong></div>
                <div class="info-box" style="padding:5px;"><span>By</span><strong style="font-size:16px;">${data.prep}</strong></div>
            </div>

            <div class="summary-sec" style="padding:8px; margin-bottom:10px;">
                <div class="sum-item"><div class="sum-lbl" style="font-size:12px;">Input</div><div class="sum-val" style="font-size:18px;">${data.input}</div></div>
                <div class="sum-item"><div class="sum-lbl" style="font-size:12px;">Defect</div><div class="sum-val text-danger" style="font-size:18px;">${data.total}</div></div>
                <div class="sum-item"><div class="sum-lbl" style="font-size:12px;">Rate %</div><div class="sum-val" style="font-size:18px; color:${parseFloat(data.rate)>1 ? 'red':'green'}">${data.rate}</div></div>
            </div>

            <h4 style="color:#003366; margin:5px 0; font-size:14px; border-bottom:1px solid #ccc;">Defect Breakdown</h4>
            
            <div style="overflow:visible;"> 
                <table class="prev-table" style="font-size:14px; width:100%;">
                    <thead>
                        <tr style="background:#eee; color:#000;">
                            <th style="padding:4px;">Defect</th>
                            <th style="padding:4px;">Qty</th>
                            <th style="padding:4px;">%</th>
                            <th style="padding:4px;">Analysis</th>
                            <th style="padding:4px;">Img</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    if(data.defects.length === 0) {
        html += `<tr><td colspan="5" style="text-align:center; color:#999;">No Defects Recorded</td></tr>`;
    } else {
        data.defects.forEach(d => {
            let imgTag = d.img ? `<img src="${d.img}" style="height:35px; border:1px solid #ccc;">` : '-';
            html += `<tr>
                <td style="padding:4px;"><b>${d.name}</b></td>
                <td style="padding:4px;">${d.qty}</td>
                <td style="padding:4px;">${d.rate}</td>
                <td style="padding:4px; color:#555;">${d.ana || '-'}</td>
                <td style="padding:4px; text-align:center;">${imgTag}</td>
            </tr>`;
        });
    }
    
    html += `</tbody></table></div></div>`;

    document.getElementById('previewBody').style.padding = "10px";
    document.getElementById('previewBody').innerHTML = html;
    document.getElementById('previewFooter').innerHTML = `<button class="btn-gray" onclick="closeModal()">Back</button><button class="btn-green" onclick="saveData()">‚úÖ Submit</button>`;
    document.getElementById('previewModal').style.display = "block";
}

function closeModal() { document.getElementById('previewModal').style.display = "none"; }

async function saveData(){
  if(!API_URL.includes("script.google.com")){ alert("Please setup API URL in code first!"); return; }
  closeModal(); document.getElementById('loader').style.display = 'block';
  let defects = [];
  document.querySelectorAll('.defect-row').forEach(row => {
    defects.push({
      name: row.querySelector('.d-name').value,
      qty: row.querySelector('.d-qty').value,
      rate: row.querySelector('.d-rate').value,
      analysis: row.querySelector('.d-ana').value,
      image: row.querySelector('.d-base64').value
    });
  });

  let payload = {
    action: "save",
    rowIndex: document.getElementById('edit_index').value,
    date: document.getElementById('e_date').value,
    line: document.getElementById('e_line').value,
    model: document.getElementById('e_model').value,
    input: document.getElementById('e_input').value,
    totalDef: document.getElementById('lbl_tot').value,
    rejRate: document.getElementById('lbl_rate').value,
    prep: document.getElementById('e_prep').value,
    defects: defects
  };

  try {
    await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) });
    alert("‚úÖ Data Saved Successfully!");
    location.reload();
  } catch(e) { alert("‚ùå Error saving data"); } 
  finally { document.getElementById('loader').style.display = 'none'; }
}

// ==========================================
// LOAD DATA
// ==========================================
async function loadData(){
  try {
    let res = await fetch(API_URL);
    let json = await res.json();
    allData = json.data;
    populateModelDropdown(); 
    renderDash();
  } catch(e) { console.log("Load Error", e); }
}

function populateModelDropdown(){
    let models = [...new Set(allData.map(r => r[2]))]; 
    let sel = document.getElementById('m_model_select');
    sel.innerHTML = '<option value="">Select Model</option>' + models.map(m => `<option value="${m}">${m}</option>`).join("");
}

// DASHBOARD RENDER
function renderDash(){
  let from = document.getElementById('dash_from').value;
  let to = document.getElementById('dash_to').value || from;
  let tBody = document.getElementById('dash_table');
  tBody.innerHTML = "";
  let stats = { all_i:0, all_d:0, f1_i:0, f1_d:0, f2_i:0, f2_d:0, fb_i:0, fb_d:0 };
  let modelMap = {}, defectMap = {};

  allData.forEach((r, idx) => {
    if(r[0] < from || r[0] > to) return;
    let line = +r[1]; let inp = +r[3]; let def = +r[4];
    let model = r[2];

    stats.all_i += inp; stats.all_d += def;
    if(line<=8) { stats.f1_i+=inp; stats.f1_d+=def; }
    else if(line<=16) { stats.f2_i+=inp; stats.f2_d+=def; }
    else { stats.fb_i+=inp; stats.fb_d+=def; }

    if(!modelMap[model]) modelMap[model] = {def:0, inp:0};
    modelMap[model].def += def;
    modelMap[model].inp += inp;

    try {
        let details = JSON.parse(r[7]);
        details.forEach(d => {
            if(!defectMap[d.name]) defectMap[d.name] = 0;
            defectMap[d.name] += +d.qty;
        });
    } catch(e) {}

    let displayRej = formatPct(r[5]);
    let valNum = parseFloat(displayRej);
    let color = valNum > 0 ? (valNum > 1 ? 'red' : '#e65100') : 'green';

    tBody.innerHTML += `<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${inp}</td><td>${r[4]}</td><td style="color:${color}; font-weight:bold;">${displayRej}</td><td><button class="btn-info" style="padding:5px;" onclick='previewEntryFromRow(${idx}, ${JSON.stringify(r)})'>View</button> <button class="btn-blue" style="padding:5px;" onclick='editRow(${idx}, ${JSON.stringify(r)})'>‚úé</button> <button class="btn-red" style="padding:5px;" onclick="delRow(${idx})">üóë</button></td></tr>`;
  });

  const rate = (d,i) => i>0 ? (d/i*100).toFixed(2)+"%" : "0.00%";
  document.getElementById('k_all').innerText = rate(stats.all_d, stats.all_i);
  document.getElementById('k_f1').innerText = rate(stats.f1_d, stats.f1_i);
  document.getElementById('k_f2').innerText = rate(stats.f2_d, stats.f2_i);
  document.getElementById('k_fb').innerText = rate(stats.fb_d, stats.fb_i);

  drawDashCharts(modelMap, defectMap, stats.all_i);
}

function drawDashCharts(modelMap, defectMap, totalInput){
    let modelArr = [['Model', 'Defects', { role: 'annotation' }]];
    let sortedModels = Object.keys(modelMap).sort((a,b)=>modelMap[b].def - modelMap[a].def).slice(0, 5);
    
    sortedModels.forEach(m => {
        let mData = modelMap[m];
        let rate = mData.inp > 0 ? (mData.def / mData.inp * 100).toFixed(2) + "%" : "0%";
        modelArr.push([m, mData.def, `${mData.def}\n(${rate})`]);
    });

    if(sortedModels.length > 0 && google.visualization){
        let data = google.visualization.arrayToDataTable(modelArr);
        new google.visualization.ColumnChart(document.getElementById('dash_chart_model')).draw(data, {
            title: 'Top 5 Models', legend: 'none', colors: ['#007bff'],
            annotations: { alwaysOutside: true, textStyle: { fontSize: 14, bold: true } },
            vAxis: { textStyle: {fontSize: 11}, viewWindow: {min:0} },
            hAxis: { textStyle: {fontSize: 10} },
            chartArea: {width: '85%', height: '65%'}
        });
    }

    let defectArr = [['Defect', 'Qty', { role: 'annotation' }]];
    let sortedDefects = Object.keys(defectMap).sort((a,b)=>defectMap[b]-defectMap[a]).slice(0, 5);
    
    sortedDefects.forEach(d => {
        let qty = defectMap[d];
        let rate = totalInput > 0 ? (qty / totalInput * 100).toFixed(2) + "%" : "0%";
        defectArr.push([d, qty, `${qty}\n(${rate})`]);
    });

    if(sortedDefects.length > 0 && google.visualization){
        let data = google.visualization.arrayToDataTable(defectArr);
        new google.visualization.ColumnChart(document.getElementById('dash_chart_defect')).draw(data, {
            title: 'Top 5 Defects', legend: 'none', colors: ['#dc3545'],
            annotations: { alwaysOutside: true, textStyle: { fontSize: 14, bold: true } },
            vAxis: { textStyle: {fontSize: 11}, viewWindow: {min:0} },
            hAxis: { textStyle: {fontSize: 10} },
            chartArea: {width: '85%', height: '65%'}
        });
    }
}

function previewEntryFromRow(idx, r){
    let data = { date: r[0], line: r[1], model: r[2], input: r[3], total: r[4], rate: formatPct(r[5]), prep: r[6] };
    let list = []; try{list=JSON.parse(r[7])}catch(e){}
    
    let html = `
        <div style="font-size:16px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px; margin-bottom:10px;">
                <div class="info-box" style="padding:5px;"><span>Date</span><strong style="font-size:16px;">${data.date}</strong></div>
                <div class="info-box" style="padding:5px;"><span>Line</span><strong style="font-size:16px;">${data.line}</strong></div>
                <div class="info-box" style="padding:5px;"><span>Model</span><strong style="font-size:16px;">${data.model}</strong></div>
                <div class="info-box" style="padding:5px;"><span>By</span><strong style="font-size:16px;">${data.prep}</strong></div>
            </div>
            <div class="summary-sec" style="padding:8px; margin-bottom:10px;">
                <div class="sum-item"><div class="sum-lbl" style="font-size:12px;">Input</div><div class="sum-val" style="font-size:18px;">${data.input}</div></div>
                <div class="sum-item"><div class="sum-lbl" style="font-size:12px;">Defect</div><div class="sum-val text-danger" style="font-size:18px;">${data.total}</div></div>
                <div class="sum-item"><div class="sum-lbl" style="font-size:12px;">Rate %</div><div class="sum-val" style="font-size:18px; color:${parseFloat(data.rate)>1 ? 'red':'green'}">${data.rate}</div></div>
            </div>
            <h4 style="color:#003366; margin:5px 0; font-size:14px; border-bottom:1px solid #ccc;">Defect Breakdown</h4>
            <div style="overflow:visible;">
                <table class="prev-table" style="font-size:14px; width:100%;">
                    <thead><tr style="background:#eee; color:#000;"><th style="padding:4px;">Defect</th><th style="padding:4px;">Qty</th><th style="padding:4px;">%</th><th style="padding:4px;">Analysis</th><th style="padding:4px;">Img</th></tr></thead>
                    <tbody>
    `;
    if(list.length === 0) html += `<tr><td colspan="5" style="text-align:center;">No Defects</td></tr>`;
    else list.forEach(d => {
        let imgTag = d.image ? `<img src="${d.image}" style="height:35px; border:1px solid #ccc;" onclick="window.open(this.src)">` : '-';
        html += `<tr><td><b>${d.name}</b></td><td>${d.qty}</td><td>${formatPct(d.rate||0)}</td><td>${d.analysis}</td><td style="text-align:center;">${imgTag}</td></tr>`;
    });
    html += `</tbody></table></div></div>`;
    document.getElementById('previewBody').style.padding = "10px";
    document.getElementById('previewBody').innerHTML = html;
    document.getElementById('previewFooter').innerHTML = `<button class="btn-gray" onclick="closeModal()">Close</button>`;
    document.getElementById('previewModal').style.display = "block";
}

function editRow(idx, r){
  showPage('entry');
  document.getElementById('edit_index').value = idx;
  document.getElementById('e_date').value = r[0];
  document.getElementById('e_line').value = r[1];
  document.getElementById('e_model').value = r[2];
  document.getElementById('e_input').value = r[3];
  document.getElementById('e_prep').value = r[6];
  document.getElementById('defect_wrapper').innerHTML = "";
  try { JSON.parse(r[7]).forEach(d => addDefectRow(d)); } catch(e) { addDefectRow(); }
  calcTotal();
}

async function delRow(idx){
  if(!confirm("Delete?")) return;
  document.getElementById('loader').style.display='block';
  await fetch(API_URL, { method:"POST", body:JSON.stringify({action:"delete", rowIndex:idx}) });
  location.reload();
}

// ==========================================
// REPORTS GENERATION (STACKED CHARTS & MARGINS)
// ==========================================
function genReport(){
  if(!allData || allData.length === 0) { alert("Data not loaded yet!"); return; }
  let start = document.getElementById('r_date_start').value;
  let end = document.getElementById('r_date_end').value;
  if(!start) return alert("Select Start Date");
  if(!end) end = start; 
  processReportData(start, end, null, 'print_area', 'r_subtitle', 'r_inp', 'r_def', 'r_rate_val', 'trend_chart_div', 'pareto_chart_div', 'analysis_list', 'remaining_list', 'model_chart_div');
}

function genModelReport(){
    if(!allData || allData.length === 0) { alert("Data not loaded yet!"); return; }
    let start = document.getElementById('m_date_start').value;
    let end = document.getElementById('m_date_end').value;
    let model = document.getElementById('m_model_select').value;
    if(!start || !model) return alert("Select Date and Model");
    if(!end) end = start;
    document.getElementById('m_name_disp').innerText = model;
    processReportData(start, end, model, 'model_print_area', 'm_subtitle', 'm_inp', 'm_def', 'm_rate_val', 'm_trend_chart', 'm_pareto_chart', 'm_analysis_list', 'm_remaining_list', null);
}

function processReportData(start, end, filterModel, areaId, subId, inpId, defId, rateId, trendId, paretoId, anaId, remId, modelChartId){
  document.getElementById(areaId).style.display = 'block';
  document.getElementById(subId).innerText = `Period: ${start} to ${end}`;
  let rData = allData.filter(r => r[0] >= start && r[0] <= end);
  if(filterModel) rData = rData.filter(r => r[2] === filterModel);
  if(rData.length === 0) { alert("No data found for this period."); document.getElementById(areaId).style.display = 'none'; return; }

  let totInp=0, totDef=0;
  let dateMap = {}, modelMap = {}, defectsMap = {};
  let exBody = document.getElementById('excel_body');
  if(exBody) exBody.innerHTML = "";

  rData.forEach(r => {
    let d = r[0]; let m = r[2]; let i = +r[3]; let df = +r[4];
    totInp += i; totDef += df;
    if(!dateMap[d]) dateMap[d] = {i:0, d:0}; dateMap[d].i += i; dateMap[d].d += df;
    if(modelChartId) { if(!modelMap[m]) modelMap[m] = {i:0, d:0}; modelMap[m].i += i; modelMap[m].d += df; }
    try {
      let list = JSON.parse(r[7]);
      list.forEach(item => {
        let name = item.name || "Unknown"; let qty = +item.qty;
        if(!defectsMap[name]) defectsMap[name] = {qty:0, imgs:[], ana:[]};
        defectsMap[name].qty += qty;
        if(item.image && defectsMap[name].imgs.length<2) defectsMap[name].imgs.push(item.image);
        if(item.analysis && !defectsMap[name].ana.includes(item.analysis)) defectsMap[name].ana.push(item.analysis);
        if(filterModel && exBody){
             let rate = i>0 ? (qty/i*100).toFixed(2)+"%" : "0%";
             exBody.innerHTML += `<tr><td>${d}</td><td>${r[1]}</td><td>${m}</td><td>${i}</td><td>${name}</td><td>${qty}</td><td>${rate}</td><td>${item.analysis}</td></tr>`;
        }
      });
    } catch(e){}
  });

  document.getElementById(inpId).innerText = totInp;
  document.getElementById(defId).innerText = totDef;
  document.getElementById(rateId).innerText = totInp>0 ? (totDef/totInp*100).toFixed(2)+"%" : "0.00%";

  // CHART OPTIONS FOR FULL VISIBILITY
  let commonOptions = {
     legend: 'none',
     chartArea: { left: 50, top: 30, width: '90%', height: '55%' }, // Reduced height to give space to hAxis
     annotations: { alwaysOutside: true, textStyle: { fontSize: 11, bold: true, color: 'black' } },
     hAxis: { slantedText: true, slantedTextAngle: 45, textStyle: { fontSize: 11 } },
     vAxis: { viewWindow: {min:0} }
  };

  // 1. TREND CHART
  try {
      let trendData = [['Date', 'Rate %', {role:'annotation'}]];
      Object.keys(dateMap).sort().forEach(dt => {
         let rt = dateMap[dt].i > 0 ? (dateMap[dt].d / dateMap[dt].i * 100) : 0;
         trendData.push([dt, rt, rt.toFixed(2)+"%"]);
      });
      let opt = {...commonOptions}; opt.title = 'Defect Trend';
      new google.visualization.LineChart(document.getElementById(trendId)).draw(google.visualization.arrayToDataTable(trendData), opt);
  } catch(e) { console.log(e); }

  // 2. MODEL CHART (Descending)
  if(modelChartId){
      try {
          let modelList = [];
          Object.keys(modelMap).forEach(md => {
             let rt = modelMap[md].i > 0 ? (modelMap[md].d / modelMap[md].i * 100) : 0;
             modelList.push({name: md, rate: rt});
          });
          modelList.sort((a,b) => b.rate - a.rate);

          let modelData = [['Model', 'Rate %', {role: 'annotation'}]];
          modelList.forEach(m => modelData.push([m.name, m.rate, m.rate.toFixed(2)+"%"]));

          let opt = {...commonOptions}; opt.title = 'Model Performance (Worst to Best)';
          new google.visualization.ColumnChart(document.getElementById(modelChartId)).draw(google.visualization.arrayToDataTable(modelData), opt);
      } catch(e) { console.log(e); }
  }

  // 3. PARETO CHART
  try {
      let sortedDefects = Object.keys(defectsMap).map(k=>({name:k, ...defectsMap[k]})).sort((a,b)=>b.qty-a.qty);
      let paretoData = [['Defect', 'Qty', {role:'annotation'}]];
      sortedDefects.forEach(s => paretoData.push([s.name, s.qty, s.qty]));
      
      if(sortedDefects.length > 0){
          let opt = {...commonOptions}; opt.title = 'Pareto Analysis';
          new google.visualization.ColumnChart(document.getElementById(paretoId)).draw(google.visualization.arrayToDataTable(paretoData), opt);
      }

      // LISTS
      let top5 = sortedDefects.slice(0, 5);
      let remaining = sortedDefects.slice(5);
      let html = "";
      top5.forEach(s => {
        let imgs = s.imgs.map(u => `<img src="${u}" class="analysis-img">`).join("");
        let defRate = totInp > 0 ? (s.qty / totInp * 100).toFixed(2) + "%" : "0.00%";
        html += `<div class="analysis-item"><div style="flex:2"><h4 style="margin:0; color:#0056b3;">${s.name}</h4><div style="display:flex; gap:15px; font-size:12px; margin:5px 0;"><span><b>Qty:</b> ${s.qty}</span><span><b>Rate:</b> ${defRate}</span></div><p style="font-size:12px; background:#f9f9f9; padding:5px; border-left:3px solid orange;"><b>Analysis:</b> ${s.ana.join(", ") || 'No analysis'}</p></div><div style="flex:1; text-align:right;">${imgs}</div></div>`;
      });
      document.getElementById(anaId).innerHTML = html;

      let remHtml = "";
      if(remaining.length > 0) remaining.forEach(r => {
          let rt = totInp > 0 ? (r.qty / totInp * 100).toFixed(2) + "%" : "0.00%";
          remHtml += `<tr><td>${r.name}</td><td>${r.qty}</td><td>${rt}</td></tr>`;
      });
      else remHtml = "<tr><td colspan='3'>No other defects</td></tr>";
      document.getElementById(remId).innerHTML = remHtml;
  } catch(e) { console.log(e); }
}

function downloadPDF(elementId, fileName){
  const el = document.getElementById(elementId);
  html2pdf().set({
      margin: 0.2, filename: fileName, image: {type:'jpeg',quality:0.98}, 
      html2canvas: {scale: 2, useCORS: true, scrollY: 0}, jsPDF: {unit:'in', format:'letter', orientation:'portrait'}
  }).from(el).save();
}
</script>
</body>
</html>
