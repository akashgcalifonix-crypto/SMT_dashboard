<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SMT Rejection Outlook- Califonix</title>
<!-- Google Fonts: Inter for UI, Roboto Mono for numbers -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
<!-- Libraries -->
<script src="https://www.gstatic.com/charts/loader.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<!-- Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root { 
    --primary: #002B5B;        /* Deep Navy */
    --primary-light: #1A5F7A;  /* Teal Blue */
    --accent: #EA5455;         /* Alert Red */
    --success: #28C76F;        /* Crisp Green */
    --warning: #FF9F43;        /* Soft Orange */
    --bg-body: #F4F5FA;        /* Light Gray Blue */
    --card-bg: #FFFFFF;
    --text-main: #2D2D2D;
    --text-muted: #6E6B7B;
    --border-radius: 10px;
    --shadow-card: 0 4px 24px 0 rgba(34, 41, 47, 0.1);
  }
  
  body { font-family: 'Inter', sans-serif; background: var(--bg-body); margin: 0; padding: 0; color: var(--text-main); -webkit-font-smoothing: antialiased; }
  
  /* --- LAYOUT GRID --- */
  .app-layout { display: flex; min-height: 100vh; }
  
  /* --- SIDEBAR NAVIGATION --- */
  .sidebar { width: 260px; background: var(--card-bg); height: 100vh; position: fixed; box-shadow: var(--shadow-card); z-index: 100; display: flex; flex-direction: column; }
  .logo-area { padding: 25px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #eee; }
  .logo-area img { height: 40px; }
  .logo-text h2 { margin: 0; font-size: 18px; font-weight: 800; color: var(--primary); }
  .logo-text p { margin: 0; font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; }
  
  .nav-links { padding: 20px 10px; flex: 1; }
  .nav-btn { 
    width: 100%; text-align: left; padding: 14px 20px; border: none; background: transparent; 
    color: var(--text-muted); font-weight: 600; font-size: 14px; cursor: pointer; 
    border-radius: 8px; margin-bottom: 5px; transition: 0.3s; display: flex; align-items: center; gap: 12px;
  }
  .nav-btn:hover { background: #f6f6f6; color: var(--primary); }
  .nav-btn.active { background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%); color: white; box-shadow: 0 4px 8px rgba(0, 43, 91, 0.25); }
  .nav-btn i { width: 20px; text-align: center; }

  /* --- MAIN CONTENT --- */
  .main-content { flex: 1; margin-left: 260px; padding: 30px; }
  
  /* --- HEADER & CATEGORY SWITCH --- */
  .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
  .page-title h1 { margin: 0; font-size: 24px; font-weight: 700; color: var(--text-main); }
  
  .category-toggler { background: white; padding: 5px; border-radius: 50px; display: flex; box-shadow: var(--shadow-card); }
  .cat-opt { padding: 10px 25px; border-radius: 40px; cursor: pointer; font-weight: 600; font-size: 13px; color: var(--text-muted); transition: 0.3s; }
  .cat-opt.active { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  
  /* --- CARDS & DASHBOARD --- */
  .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; }
  .kpi-card { background: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow-card); position: relative; overflow: hidden; }
  .kpi-card h4 { margin: 0 0 10px 0; color: var(--text-muted); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
  .kpi-value { font-size: 28px; font-weight: 800; font-family: 'Roboto Mono', monospace; color: var(--primary); }
  .kpi-icon { position: absolute; right: 20px; top: 20px; font-size: 40px; opacity: 0.1; color: var(--primary); }
  
  .charts-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; margin-bottom: 25px; }
  .chart-box { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-card); min-height: 400px; }
  
  /* --- DATA TABLES --- */
  .table-responsive { background: white; border-radius: var(--border-radius); box-shadow: var(--shadow-card); overflow: hidden; }
  .styled-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .styled-table th { background: #f8f8f8; color: var(--text-muted); font-weight: 700; text-transform: uppercase; padding: 15px; text-align: left; border-bottom: 2px solid #eee; }
  .styled-table td { padding: 14px 15px; border-bottom: 1px solid #f2f2f2; color: #333; }
  .styled-table tr:hover { background: #fafafa; }
  .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
  .bg-success { background: rgba(40, 199, 111, 0.15); color: #28C76F; }
  .bg-warning { background: rgba(255, 159, 67, 0.15); color: #FF9F43; }
  .bg-danger { background: rgba(234, 84, 85, 0.15); color: #EA5455; }

  /* --- FORMS & INPUTS --- */
  .control-panel { background: white; padding: 20px; border-radius: var(--border-radius); box-shadow: var(--shadow-card); margin-bottom: 20px; display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
  .form-group { flex: 1; min-width: 150px; }
  .form-group label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); margin-bottom: 6px; text-transform: uppercase; }
  .form-control { width: 100%; padding: 10px 12px; border: 1px solid #d8d6de; border-radius: 6px; font-size: 14px; font-family: 'Inter', sans-serif; transition: 0.3s; box-sizing: border-box; }
  .form-control:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0, 43, 91, 0.1); }
  
  .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 13px; display: inline-flex; align-items: center; gap: 8px; }
  .btn-primary { background: var(--primary); color: white; }
  .btn-success { background: var(--success); color: white; }
  .btn-danger { background: var(--accent); color: white; }
  .btn-info { background: #00CFDD; color: white; }
  .btn:hover { transform: translateY(-2px); opacity: 0.9; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }

  /* --- DEFECT ENTRY ROWS --- */
  .defect-row { background: #fcfcfc; border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
  .defect-row > div { flex: 1; min-width: 100px; }

  /* --- PREVIEW MODAL (The Ticket) --- */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 2000; justify-content: center; align-items: center; }
  .ticket-modal { background: white; width: 900px; max-width: 95%; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.2); animation: slideUp 0.3s ease; }
  .ticket-header { background: var(--primary); color: white; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; }
  .ticket-body { padding: 30px; background: #f8f9fa; }
  .ticket-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
  .ticket-info { background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee; }
  .ticket-info span { display: block; font-size: 10px; text-transform: uppercase; color: #999; font-weight: 700; margin-bottom: 4px; }
  .ticket-info strong { font-size: 14px; color: #333; }
  .ticket-summary { display: flex; gap: 2px; margin-bottom: 20px; border-radius: 8px; overflow: hidden; }
  .ts-box { flex: 1; background: var(--primary); color: white; padding: 20px; text-align: center; }
  .ts-box.alert { background: var(--accent); }
  .ts-val { font-size: 24px; font-weight: 800; display: block; }
  .ts-lbl { font-size: 11px; opacity: 0.8; text-transform: uppercase; }

  /* --- REPORTS (Print Ready) --- */
  .report-sheet { background: white; padding: 40px; margin: 0 auto; max-width: 297mm; min-height: 210mm; box-shadow: var(--shadow-card); display: none; margin-top: 20px; }
  .report-header { border-bottom: 3px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; }
  .report-title h1 { margin: 0; color: var(--primary); font-size: 28px; text-transform: uppercase; letter-spacing: 1px; }
  .report-title p { margin: 5px 0 0; color: var(--text-muted); }
  .report-section-title { font-size: 16px; font-weight: 800; color: var(--primary); border-left: 5px solid var(--accent); padding-left: 10px; margin: 30px 0 15px 0; background: #f4f5fa; padding: 10px; }
  .analysis-card { background: #fffde7; border-left: 4px solid #fbc02d; padding: 15px; margin-bottom: 10px; border-radius: 4px; }
  
  /* --- MULTI SELECT --- */
  .multiselect { width: 100%; position: relative; }
  .selectBox { position: relative; cursor: pointer; }
  .overSelect { position: absolute; left: 0; right: 0; top: 0; bottom: 0; }
  #checkboxes { display: none; border: 1px solid #ccc; max-height: 200px; overflow-y: scroll; position: absolute; width: 100%; background: white; z-index: 100; box-shadow: 0 4px 15px rgba(0,0,0,0.15); padding: 10px; border-radius: 0 0 8px 8px; }
  #checkboxes label { display: block; padding: 5px; cursor: pointer; }
  #checkboxes label:hover { background: #f0f0f0; }

  @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  
  /* Print Media Query */
  @media print {
    body { background: white; }
    .sidebar, .top-bar, .control-panel, .no-print { display: none !important; }
    .main-content { margin: 0; padding: 0; }
    .report-sheet { box-shadow: none; margin: 0; width: 100%; max-width: 100%; }
    .page-break { page-break-before: always; }
  }

  #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
  .spinner { width: 50px; height: 50px; border: 5px solid #eee; border-top: 5px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <h3 style="color:var(--primary); margin-top:20px;">Loading Data...</h3>
</div>

<div class="app-layout">
    
    <!-- SIDEBAR -->
    <nav class="sidebar">
        <div class="logo-area">
            <img src="https://i.postimg.cc/5y7SN4xc/logo.png" alt="Logo">
            <div class="logo-text">
                <h2>CALIFONIX</h2>
                <p>Quality Control</p>
            </div>
        </div>
        <div class="nav-links">
            <button class="nav-btn active" onclick="showPage('dashboard', this)"><i class="fas fa-chart-pie"></i> Dashboard</button>
            <button class="nav-btn" onclick="showPage('entry', this)"><i class="fas fa-edit"></i> Data Entry</button>
            <button class="nav-btn" onclick="showPage('report', this)"><i class="fas fa-file-alt"></i> Overall Report</button>
            <button class="nav-btn" onclick="showPage('model_report', this)"><i class="fas fa-headphones"></i> Model Report</button>
            <button class="nav-btn" onclick="showPage('defect_report', this)"><i class="fas fa-bug"></i> Defect Analysis</button>
            <button class="nav-btn" onclick="showPage('month_report', this)"><i class="fas fa-calendar-alt"></i> Monthly Overview</button>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        
        <!-- HEADER -->
        <div class="top-bar no-print">
            <div class="page-title">
                <h1 id="page_header">Dashboard Overview</h1>
            </div>
            <div class="category-toggler">
                <div id="btn_earbuds" class="cat-opt active" onclick="switchCategory('Earbuds')">üéß Earbuds</div>
                <div id="btn_case" class="cat-opt" onclick="switchCategory('ChargingCase')">üîã Charging Case</div>
            </div>
        </div>

        <!-- 1. DASHBOARD -->
        <div id="dashboard">
            <div class="control-panel">
                <div class="form-group"><label>From Date</label><input type="date" id="dash_from" class="form-control"></div>
                <div class="form-group"><label>To Date</label><input type="date" id="dash_to" class="form-control"></div>
                <button class="btn btn-primary" onclick="renderDash()">Apply Filter</button>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <h4>Overall Rejection</h4><div class="kpi-value" id="k_all">0%</div><i class="fas fa-percentage kpi-icon"></i>
                </div>
                <div class="kpi-card">
                    <h4>Floor 1 Rate</h4><div class="kpi-value" style="color:var(--success)" id="k_f1">0%</div><i class="fas fa-layer-group kpi-icon"></i>
                </div>
                <div class="kpi-card">
                    <h4>Floor 2 Rate</h4><div class="kpi-value" style="color:var(--warning)" id="k_f2">0%</div><i class="fas fa-layer-group kpi-icon"></i>
                </div>
                <div class="kpi-card">
                    <h4>Basement Rate</h4><div class="kpi-value" style="color:var(--primary)" id="k_fb">0%</div><i class="fas fa-layer-group kpi-icon"></i>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-box" id="dash_chart_model"></div>
                <div class="chart-box" id="dash_chart_defect"></div>
            </div>

            <div class="table-responsive">
                <table class="styled-table">
                    <thead><tr><th>Date</th><th>Shift</th><th>Line</th><th>Model</th><th>Input</th><th>Defects</th><th>Rej %</th><th>Actions</th></tr></thead>
                    <tbody id="dash_table"></tbody>
                </table>
            </div>
        </div>

        <!-- 2. DATA ENTRY -->
        <div id="entry" style="display:none;">
            <div class="control-panel" style="display:block;">
                <h3 style="margin-top:0; color:var(--primary); border-bottom:1px solid #eee; padding-bottom:15px;">üìù Add / Edit Record</h3>
                <input type="hidden" id="edit_index"><input type="hidden" id="edit_sheet_name">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:15px; margin-bottom:20px;">
                    <div class="form-group"><label>Date</label><input type="date" id="e_date" class="form-control"></div>
                    <div class="form-group"><label>Shift</label><select id="e_shift" class="form-control"><option value="A">Shift A</option><option value="B">Shift B</option><option value="C">Shift C</option></select></div>
                    <div class="form-group"><label>Line</label><input type="number" id="e_line" class="form-control" placeholder="1-24"></div>
                    <div class="form-group"><label>Model</label><select id="e_model" class="form-control"><option value="">Select Model</option></select></div>
                    <div class="form-group"><label>Input Qty</label><input type="number" id="e_input" class="form-control" oninput="calcTotal()"></div>
                    <div class="form-group"><label>Operator/Prep By</label><input type="text" id="e_prep" class="form-control"></div>
                </div>

                <div style="background:#f8f9fa; padding:20px; border-radius:8px; border:1px dashed #ccc;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <h4 style="margin:0;">Defect Details</h4>
                        <button class="btn btn-info" onclick="addDefectRow()">+ Add Defect</button>
                    </div>
                    <div id="defect_wrapper"></div>
                </div>
                
                <div style="margin-top:20px; display:flex; gap:20px; align-items:center; background:#e3f2fd; padding:15px; border-radius:8px;">
                    <div class="form-group"><label>Total Defects</label><input type="text" id="lbl_tot" readonly class="form-control" style="font-weight:bold;"></div>
                    <div class="form-group"><label>Rejection Rate</label><input type="text" id="lbl_rate" readonly class="form-control" style="color:var(--accent); font-weight:800; font-size:18px;"></div>
                    <button class="btn btn-primary" style="height:45px; margin-top:18px; flex:1;" onclick="previewEntry()">PREVIEW & SUBMIT</button>
                </div>
            </div>
        </div>

        <!-- REPORTS CONTAINER -->
        <div id="report" style="display:none;">
            <div class="control-panel no-print">
                <div class="form-group"><label>From</label><input type="date" id="r_date_start" class="form-control"></div>
                <div class="form-group"><label>To</label><input type="date" id="r_date_end" class="form-control"></div>
                <button class="btn btn-primary" onclick="genReport()">Generate</button>
                <button class="btn btn-success" onclick="downloadPDF('print_area', 'Overall_Report.pdf')">PDF</button>
            </div>
            <div id="print_area" class="report-sheet">
                <div class="report-header"><div class="report-title"><h1>Overall Quality Analysis</h1><p>Period: <span id="r_subtitle">--</span></p></div><img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height:50px;"></div>
                <div class="ticket-summary">
                    <div class="ts-box"><span class="ts-lbl">Total Input</span><span class="ts-val" id="r_inp">0</span></div>
                    <div class="ts-box alert"><span class="ts-lbl">Total Defects</span><span class="ts-val" id="r_def">0</span></div>
                    <div class="ts-box" style="background:var(--warning); color:white;"><span class="ts-lbl">Rejection Rate</span><span class="ts-val" id="r_rate_val">0%</span></div>
                </div>
                <div class="report-section-title">Rejection Trend</div><div id="trend_chart_div" style="width:100%; height:300px;"></div>
                <div class="report-section-title">Model Performance</div><div id="model_chart_div" style="width:100%; height:300px;"></div>
                <div class="report-section-title">Pareto Analysis</div><div id="pareto_chart_div" style="width:100%; height:300px;"></div>
                <div class="report-section-title">Top 5 Defects Analysis</div><div id="analysis_list"></div>
                <div class="report-section-title">Remaining Defects Data</div><table class="styled-table"><tbody id="remaining_list"></tbody></table>
            </div>
        </div>

        <!-- MODEL REPORT -->
        <div id="model_report" style="display:none;">
            <div class="control-panel no-print">
                <div class="form-group"><label>From</label><input type="date" id="m_date_start" class="form-control"></div>
                <div class="form-group"><label>To</label><input type="date" id="m_date_end" class="form-control"></div>
                <div class="form-group" style="flex:2;">
                    <label>Select Models</label>
                    <div class="multiselect">
                        <div class="selectBox" onclick="showCheckboxes()"><select class="form-control"><option>Select Models</option></select><div class="overSelect"></div></div>
                        <div id="checkboxes"></div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="genModelReport()">View</button>
                <button class="btn btn-success" onclick="downloadPDF('model_print_area', 'Model_Report.pdf')">PDF</button>
                <button class="btn btn-info" onclick="downloadExcel('excel_table', 'Model_Report.xls')">Excel</button>
            </div>
            <div id="model_print_area" class="report-sheet">
                <div class="report-header"><div class="report-title"><h1>Specific Model Report</h1><p>Period: <span id="m_subtitle">--</span></p></div><img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height:50px;"></div>
                <div style="background:#f0f2f5; padding:15px; border-radius:5px; margin-bottom:20px;"><strong>Models:</strong> <span id="m_name_disp">--</span></div>
                <div class="ticket-summary">
                    <div class="ts-box"><span class="ts-lbl">Input</span><span class="ts-val" id="m_inp">0</span></div>
                    <div class="ts-box alert"><span class="ts-lbl">Defects</span><span class="ts-val" id="m_def">0</span></div>
                    <div class="ts-box" style="background:var(--warning);"><span class="ts-lbl">Rate</span><span class="ts-val" id="m_rate_val">0%</span></div>
                </div>
                <div id="m_trend_chart" style="width:100%; height:300px; margin-bottom:20px;"></div>
                <div id="m_pareto_chart" style="width:100%; height:300px; margin-bottom:20px;"></div>
                <div class="report-section-title">Analysis (Editable)</div><div id="m_analysis_list"></div>
                <table class="styled-table"><tbody id="m_remaining_list"></tbody></table>
            </div>
            <table id="excel_table" style="display:none;"><thead><tr><th>Date</th><th>Shift</th><th>Line</th><th>Model</th><th>Input</th><th>Defect Name</th><th>Qty</th><th>Ref ID</th><th>Analysis</th></tr></thead><tbody id="excel_body"></tbody></table>
        </div>

        <!-- DEFECT REPORT -->
        <div id="defect_report" style="display:none;">
            <div class="control-panel no-print">
                <div class="form-group"><label>From</label><input type="date" id="d_date_start" class="form-control"></div>
                <div class="form-group"><label>To</label><input type="date" id="d_date_end" class="form-control"></div>
                <div class="form-group"><label>Defect Type</label><select id="d_defect_select" class="form-control"></select></div>
                <button class="btn btn-primary" onclick="genDefectWiseReport()">Generate</button>
                <button class="btn btn-success" onclick="downloadPDF('defect_print_area', 'Defect_Report.pdf')">PDF</button>
                <button class="btn btn-info" onclick="downloadProfessionalPPT('Defect')">PPT</button>
            </div>
            <div id="defect_print_area" class="report-sheet">
                <div class="report-header"><div class="report-title"><h1>Defect Deep Dive</h1><p>Period: <span id="d_subtitle">--</span></p></div><img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height:50px;"></div>
                <div class="ticket-summary">
                    <div class="ts-box" style="background:#333;"><span class="ts-lbl">Defect Type</span><span class="ts-val" style="font-size:18px;" id="d_name_disp">--</span></div>
                    <div class="ts-box alert"><span class="ts-lbl">Total Occurrences</span><span class="ts-val" id="d_tot_qty">0</span></div>
                    <div class="ts-box" style="background:var(--warning);"><span class="ts-lbl">Models Affected</span><span class="ts-val" id="d_aff_models">0</span></div>
                </div>
                <div id="d_contrib_chart" style="width:100%; height:350px;"></div>
                <div class="report-section-title">Root Cause Analysis</div><div id="d_analysis_list"></div>
                <div class="report-section-title">Model Breakdown</div>
                <table class="styled-table"><tbody id="defect_detail_body"></tbody></table>
            </div>
            <table id="defect_excel_table" style="display:none;"><tbody id="defect_excel_body"></tbody></table>
        </div>

        <!-- MONTHLY REPORT -->
        <div id="month_report" style="display:none;">
            <div class="control-panel no-print">
                <div class="form-group"><label>Select Month</label><input type="month" id="mo_picker" class="form-control"></div>
                <button class="btn btn-primary" onclick="genMonthReport()">Load Data</button>
                <button class="btn btn-success" onclick="downloadPDF('month_print_area', 'Monthly_Report.pdf')">PDF</button>
                <button class="btn btn-info" onclick="downloadProfessionalPPT('Month')">Professional PPT</button>
            </div>
            <div id="month_print_area" class="report-sheet">
                <div class="report-header"><div class="report-title"><h1>Monthly Performance Review</h1><p id="mo_subtitle">--</p></div><img src="https://i.postimg.cc/5y7SN4xc/logo.png" style="height:50px;"></div>
                <div class="ticket-summary">
                    <div class="ts-box"><span class="ts-lbl">Total Input</span><span class="ts-val" id="mo_inp">0</span></div>
                    <div class="ts-box alert"><span class="ts-lbl">Total Defects</span><span class="ts-val" id="mo_def">0</span></div>
                    <div class="ts-box" style="background:var(--warning);"><span class="ts-lbl">Rejection Rate</span><span class="ts-val" id="mo_rate">0%</span></div>
                </div>
                <div id="mo_trend_chart" style="width:100%; height:300px; margin-bottom:20px;"></div>
                <div style="display:flex; gap:20px;">
                    <div id="mo_model_chart" style="flex:1; height:300px;"></div>
                    <div id="mo_pareto_chart" style="flex:1; height:300px;"></div>
                </div>
                <div class="report-section-title">Month Analysis</div><div id="mo_analysis_list"></div>
            </div>
            <table id="month_excel_table" style="display:none;"><tbody id="month_excel_body"></tbody></table>
        </div>

    </main>
</div>

<!-- PREVIEW MODAL -->
<div id="previewModal" class="modal-overlay">
    <div class="ticket-modal">
        <div class="ticket-header">
            <h3>QUALITY DATA TICKET</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:20px;" onclick="closeModal()"></i>
        </div>
        <div class="ticket-body" id="previewBody"></div>
        <div style="padding:20px; text-align:right; background:#eee; display:flex; justify-content:flex-end; gap:10px;" id="previewFooter"></div>
    </div>
</div>

<script>
/* -------------------------------------------------------------------------
   APP CONFIG & STATE
------------------------------------------------------------------------- */
const API_URL = "https://script.google.com/macros/s/AKfycbweFBgyW1LR3SLr0wHrt_dUXRXmN1qGwNjbmhcmCTLMzjm3wjTeNA1wofzAz801zEvmng/exec";
const LOGO_URL = "https://i.postimg.cc/5y7SN4xc/logo.png";
const MASTER_MODELS=["Ad Unity ANC","Ace","Ad 111v2","Ad 118","Ad 120","Ad 121Pro Plus","Ad 131 Elite Anc","Ad 131 Gen 2","Ad 131 Pro Buds","Ad 138 Gen 2","Ad 141 Anc","Ad 141 Anc Elite","Ad 141 Gen 2","Ad 141 Pro Buds","Ad 148 Gen 2","Ad 155","Ad 161 Anc","Ad 161 Anc Elite","Ad 161 N","Ad 181 Pro","Ad 191 Anc","Ad 192","Ad 212","Ad 213","Ad 280 Anc","Ad 300","Ad 301","Ad 311 Pro","Ad 313","Ad 701 Anc","AD 71","Ad 800","Ad 800 Hidef","Ad 91","Ad 91 Prime","Ad Ace Gen 2","Ad Alpha Gen 2","AD Hype","AD Kick","Ad Nirvana Crystal","Ad Nirvana Iris","Ad Nirvana X","Ad Plus 311","Ad Plus 318","Ad Prime 412","Ad Prime 513 Anc","Ad Primo","Ad Pulse","AD Supreme","Ad Ultra Pro","Ad100","Ad121 Pro","Ad125","Ad131","Ad131 Pro","Ad138","Ad138 Pro","Ad141","Ad148","Ad161","AD161 Pro-Buds","AD163","Ad170","AD181","AD183","Ad190","AD191 G","Airdopes 207","Alpha","Amazon basics","Atom 81 Pro","Atom 83","Atom81","Dashcam Hive E1","Dashcam Hive F1","HMD P50","HMD P60","HMD P70","HMD S60","HMD X50","HMD X50 Pro","IMT 100","IMT101","IMT121","IMT128","IMT131","IMT161","IMT181","Joy","Max","Nirvana","Nirvana Ion (ANC)","Nirvana Ion ANC Pro","Nirvana ION N Mold","R 195 Pro","Ultra Plus","Zing"];
const MASTER_DEFECTS=["Body Sensor Fail","Single LED glow","Channel Fail","SMD Component damaged","DUT Mode Fail","Electric sound","Heating","High Current","Enquiry","LED Not glow","LED Auto glow ","LED Miss","Low current","Secondary MIC Fail","Talk MIC Fail","Not On","POGO Pin shift","POGO Pin Miss","Software skip","RF Fail","CTC Fail","Speaker Fail","Scrap","Extra Burr","Hall Sensor","Sleep mode","Key Not work","Charging not stored","FPC connector issue","Mic Distortion"];

const CONFIG = { Earbuds: { defects: MASTER_DEFECTS, models: MASTER_MODELS }, ChargingCase: { defects: MASTER_DEFECTS, models: MASTER_MODELS } };
let currentCategory="Earbuds", rawData={earbuds:[],charging_case:[]}, currentData=[], chartInstances={}; 
google.charts.load('current', {'packages':['corechart', 'bar']});

function normalizeDate(dateStr) {
    if (!dateStr) return "";
    const d = new Date(dateStr);
    if(isNaN(d)) return dateStr; 
    return d.toLocaleDateString('en-CA');
}

window.onload = () => {
    const today = new Date().toLocaleDateString('en-CA');
    document.getElementById('e_date').value = today;
    document.getElementById('dash_from').value = today;
    document.getElementById('mo_picker').value = today.substring(0, 7);
    loadAllData();
};

function switchCategory(cat) {
    currentCategory = cat;
    document.getElementById('btn_earbuds').className = cat === 'Earbuds' ? 'cat-opt active' : 'cat-opt';
    document.getElementById('btn_case').className = cat === 'ChargingCase' ? 'cat-opt active' : 'cat-opt';
    currentData = (cat === 'Earbuds') ? rawData.earbuds : rawData.charging_case;
    updateDropdowns();
    renderDash();
}

function updateDropdowns(){
    let dList = document.getElementById('e_model'); dList.innerHTML = '<option value="">Select Model</option>';
    let existingModels = [...new Set(currentData.map(r=>r[2]))];
    [...new Set([...CONFIG[currentCategory].models, ...existingModels])].sort().forEach(m => { let opt = document.createElement('option'); opt.value = m; opt.innerText = m; dList.appendChild(opt); });
    document.getElementById('d_defect_select').innerHTML = '<option value="">Select Defect</option>' + CONFIG[currentCategory].defects.map(d=>`<option value="${d}">${d}</option>`).join('');
    let cb = document.getElementById('checkboxes'); cb.innerHTML = "";
    [...new Set([...CONFIG[currentCategory].models, ...existingModels])].sort().forEach(m => { let l=document.createElement('label'); l.innerHTML=`<input type="checkbox" value="${m}" /> ${m}`; cb.appendChild(l); });
}

let expanded = false;
function showCheckboxes() { let c = document.getElementById("checkboxes"); c.style.display = expanded ? "none" : "block"; expanded = !expanded; }

function showPage(id, btn){ 
    document.querySelectorAll('#dashboard, #entry, #report, #model_report, #defect_report, #month_report').forEach(d => d.style.display='none'); 
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if(btn) btn.classList.add('active');
    document.getElementById(id).style.display='block';
    
    let titles = {dashboard:"Dashboard Overview", entry:"Data Entry Portal", report:"Comprehensive Analysis", model_report:"Model Specific Report", defect_report:"Defect Deep Dive", month_report:"Monthly Summary"};
    document.getElementById('page_header').innerText = titles[id];
}

function formatPct(val) { let s = String(val); if(s.includes("%")) return s; let n = parseFloat(s); return isNaN(n) ? "0.00%" : (n * 100).toFixed(2) + "%"; }

/* -------------------------------------------------------------------------
   DATA ENTRY
------------------------------------------------------------------------- */
function addDefectRow(data = null){
  const div = document.createElement('div'); div.className = 'defect-row';
  let options = CONFIG[currentCategory].defects.map(d => `<option value="${d}">${d}</option>`).join("");
  div.innerHTML = `<div><label>Defect</label><select class="form-control d-name"><option value="">Select</option>${options}</select></div><div><label>Ref/Loc</label><input class="form-control d-ref"></div><div><label>Qty</label><input type="number" class="form-control d-qty" oninput="calcTotal()"></div><div style="max-width:80px;"><label>%</label><input class="form-control d-rate" readonly></div><div><label>Analysis</label><input class="form-control d-ana"></div><div><label>Image</label><input type="file" onchange="handleImg(this)"></div><div style="text-align:center;"><img class="img-preview" style="height:30px; display:none;"><input type="hidden" class="d-base64"><button class="btn btn-danger" onclick="this.parentElement.parentElement.remove(); calcTotal()">x</button></div>`;
  document.getElementById('defect_wrapper').appendChild(div);
  if(data){
      div.querySelector('.d-name').value = data.name; div.querySelector('.d-qty').value = data.qty;
      div.querySelector('.d-rate').value = formatPct(data.rate||0); div.querySelector('.d-ana').value = data.analysis;
      div.querySelector('.d-ref').value = data.ref||"";
      if(data.image) { div.querySelector('.img-preview').src = data.image; div.querySelector('.img-preview').style.display='block'; div.querySelector('.d-base64').value=data.image; }
  }
}

function handleImg(input){ if(input.files && input.files[0]){ const r = new FileReader(); r.onload = (e) => { let i = new Image(); i.onload = () => { let c = document.createElement('canvas'); let x = c.getContext('2d'); let w=i.width, h=i.height; if(w>600){h*=600/w;w=600;} c.width=w; c.height=h; x.drawImage(i,0,0,w,h); let row=input.closest('.defect-row'); row.querySelector('.img-preview').src=c.toDataURL('image/jpeg',0.6); row.querySelector('.img-preview').style.display='block'; row.querySelector('.d-base64').value=c.toDataURL('image/jpeg',0.6); }; i.src = e.target.result; }; r.readAsDataURL(input.files[0]); } }
function calcTotal(){ 
    let inp = +document.getElementById('e_input').value || 0; let tot = 0;
    document.querySelectorAll('.d-qty').forEach(i => tot += (+i.value||0));
    document.getElementById('lbl_tot').value = tot;
    document.getElementById('lbl_rate').value = inp > 0 ? (tot/inp*100).toFixed(2)+"%" : "0.00%";
    document.querySelectorAll('.defect-row').forEach(row => { let q = +row.querySelector('.d-qty').value || 0; row.querySelector('.d-rate').value = (inp>0 && q>0) ? (q/inp*100).toFixed(2)+"%" : "0%"; });
}

/* -------------------------------------------------------------------------
   PREVIEW MODAL (TICKET STYLE)
------------------------------------------------------------------------- */
function previewEntry() { renderPreviewModal(getEntryData()); }
function getEntryData() {
    let d = {
        date: document.getElementById('e_date').value, shift: document.getElementById('e_shift').value,
        line: document.getElementById('e_line').value, model: document.getElementById('e_model').value,
        input: document.getElementById('e_input').value, total: document.getElementById('lbl_tot').value,
        rate: document.getElementById('lbl_rate').value, prep: document.getElementById('e_prep').value, defects: []
    };
    document.querySelectorAll('.defect-row').forEach(r => {
        d.defects.push({
            name: r.querySelector('.d-name').value, ref: r.querySelector('.d-ref').value,
            qty: r.querySelector('.d-qty').value, rate: r.querySelector('.d-rate').value,
            ana: r.querySelector('.d-ana').value, img: r.querySelector('.d-base64').value
        });
    });
    return d;
}
function previewEntryFromRow(idx) {
    let r = currentData[idx];
    let d = { date: normalizeDate(r[0]), shift: r[8]||'-', line: r[1], model: r[2], input: r[3], total: r[4], rate: formatPct(r[5]), prep: r[6], defects: [] };
    try { let defs = JSON.parse(r[7]); defs.forEach(x => { 
        let dr = (+r[3]>0) ? ((+x.qty)/r[3]*100).toFixed(2)+"%" : "0%";
        d.defects.push({ name:x.name, ref:x.ref, qty:x.qty, rate:dr, ana:x.analysis, img:x.image }); 
    }); } catch(e){}
    renderPreviewModal(d, true);
}

function renderPreviewModal(data, isReadOnly=false){
    let html = `
    <div class="ticket-grid">
        <div class="ticket-info"><span>Model</span><strong>${data.model}</strong></div>
        <div class="ticket-info"><span>Date/Shift</span><strong>${data.date} (${data.shift})</strong></div>
        <div class="ticket-info"><span>Line</span><strong>${data.line}</strong></div>
        <div class="ticket-info"><span>Operator</span><strong>${data.prep}</strong></div>
    </div>
    <div class="ticket-summary">
        <div class="ts-box"><span class="ts-lbl">Input</span><span class="ts-val">${data.input}</span></div>
        <div class="ts-box alert"><span class="ts-lbl">Defects</span><span class="ts-val">${data.total}</span></div>
        <div class="ts-box" style="background:#555"><span class="ts-lbl">Rate</span><span class="ts-val">${data.rate}</span></div>
    </div>
    <table class="styled-table"><thead><tr><th>Defect</th><th>Ref</th><th>Qty</th><th>%</th><th>Evidence</th></tr></thead><tbody>`;
    data.defects.forEach(d => {
        let img = d.img ? `<img src="${d.img}" style="height:30px; cursor:zoom-in" onclick="window.open(this.src)">` : '-';
        html += `<tr><td>${d.name}<br><small style="color:#888">${d.ana||''}</small></td><td>${d.ref}</td><td><b>${d.qty}</b></td><td>${d.rate}</td><td>${img}</td></tr>`;
    });
    html += `</tbody></table>`;
    document.getElementById('previewBody').innerHTML = html;
    let ft = document.getElementById('previewFooter');
    if(!isReadOnly) ft.innerHTML = `<button class="btn btn-primary" onclick="saveData()">CONFIRM & UPLOAD</button>`;
    else ft.innerHTML = `<button class="btn btn-info" onclick="closeModal()">Close</button>`;
    document.getElementById('previewModal').style.display = "flex";
}
function closeModal() { document.getElementById('previewModal').style.display = "none"; }

/* -------------------------------------------------------------------------
   API ACTIONS
------------------------------------------------------------------------- */
async function saveData(){
  if(!API_URL.includes("script.google.com")){ alert("Configure API URL"); return; }
  closeModal(); document.getElementById('loader').style.display = 'flex';
  let d = getEntryData();
  let payload = { action: "save", category: currentCategory, sheetName: currentCategory==="ChargingCase"?"Data_ChargingCase":"Data_Earbuds", rowIndex: document.getElementById('edit_index').value, date: d.date, shift: d.shift, line: d.line, model: d.model, input: d.input, totalDef: d.total, rejRate: d.rate, prep: d.prep, defects: d.defects.map(x=>({name:x.name, ref:x.ref, qty:x.qty, rate:x.rate, analysis:x.ana, action:"", image:x.img})), defectList: CONFIG[currentCategory].defects };
  try { await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) }); alert("Saved!"); location.reload(); } 
  catch(e) { alert("Error"); } finally { document.getElementById('loader').style.display = 'none'; }
}

async function deleteRow(idx){
    if(!confirm("DELETE record?")) return;
    let r = currentData[idx];
    document.getElementById('loader').style.display = 'flex';
    let payload = { action: "delete", category: currentCategory, sheetName: r[9], rowIndex: r[10] };
    try { await fetch(API_URL, { method: "POST", body: JSON.stringify(payload) }); alert("Deleted"); location.reload(); } catch(e) { alert("Error"); } finally { document.getElementById('loader').style.display = 'none'; }
}

async function loadAllData(){
  try { let res = await fetch(API_URL); rawData = await res.json(); switchCategory("Earbuds"); } catch(e) { console.log(e); } finally { document.getElementById('loader').style.display = 'none'; }
}

/* -------------------------------------------------------------------------
   DASHBOARD LOGIC
------------------------------------------------------------------------- */
function renderDash(){
  let from = document.getElementById('dash_from').value; let to = document.getElementById('dash_to').value || from;
  let tBody = document.getElementById('dash_table'); tBody.innerHTML = "";
  let stats = { all_i:0, all_d:0, f1_i:0, f1_d:0, f2_i:0, f2_d:0, fb_i:0, fb_d:0 };
  let mMode = {}, mDef = {};

  // Clean Chart Options
  const chartOpts = { backgroundColor: 'transparent', chartArea: { width: '85%', height: '75%' }, legend: { position: 'none' }, vAxis: { gridlines: { color: '#f0f0f0' }, textStyle: { color: '#999' } }, hAxis: { textStyle: { color: '#999', fontSize: 10 } }, colors:['#002B5B'] };

  currentData.forEach((r, idx) => {
    let rowDate = normalizeDate(r[0]);
    if(rowDate < from || rowDate > to) return;
    
    let ln = +r[1], inp = +r[3], def = +r[4];
    stats.all_i += inp; stats.all_d += def;
    if(ln<=8) { stats.f1_i+=inp; stats.f1_d+=def; } else if(ln<=16) { stats.f2_i+=inp; stats.f2_d+=def; } else { stats.fb_i+=inp; stats.fb_d+=def; }
    
    if(!mMode[r[2]]) mMode[r[2]]={d:0, i:0}; mMode[r[2]].d+=def; mMode[r[2]].i+=inp;
    try { JSON.parse(r[7]).forEach(d=>{ if(!mDef[d.name]) mDef[d.name]=0; mDef[d.name]+=(+d.qty); }); } catch(e){}
    
    let rateNum = parseFloat(r[5]);
    let badge = rateNum > 0.05 ? 'bg-danger' : (rateNum > 0 ? 'bg-warning' : 'bg-success');
    
    tBody.innerHTML += `<tr>
        <td style="font-family:'Roboto Mono'">${rowDate}</td><td>${r[8]}</td><td>${r[1]}</td>
        <td><b>${r[2]}</b></td><td>${inp}</td><td>${def}</td>
        <td><span class="status-badge ${badge}">${formatPct(r[5])}</span></td>
        <td><i class="fas fa-eye" style="cursor:pointer; color:var(--primary); margin-right:8px;" onclick='previewEntryFromRow(${idx})'></i> <i class="fas fa-pen" style="cursor:pointer; color:orange; margin-right:8px;" onclick='editRow(${idx})'></i> <i class="fas fa-trash" style="cursor:pointer; color:red;" onclick='deleteRow(${idx})'></i></td>
    </tr>`;
  });
  
  const rate = (d,i) => i>0 ? (d/i*100).toFixed(2)+"%" : "0.00%";
  document.getElementById('k_all').innerText = rate(stats.all_d, stats.all_i);
  document.getElementById('k_f1').innerText = rate(stats.f1_d, stats.f1_i);
  document.getElementById('k_f2').innerText = rate(stats.f2_d, stats.f2_i);
  document.getElementById('k_fb').innerText = rate(stats.fb_d, stats.fb_i);
  
  let mA = [['Model','Qty',{role:'style'}]]; Object.keys(mMode).sort((a,b)=>mMode[b].d - mMode[a].d).slice(0,5).forEach(k => mA.push([k, mMode[k].d, 'color:#002B5B']));
  let dA = [['Defect','Qty',{role:'style'}]]; Object.keys(mDef).sort((a,b)=>mDef[b]-mDef[a]).slice(0,5).forEach(k => dA.push([k, mDef[k], 'color:#EA5455']));

  new google.visualization.ColumnChart(document.getElementById('dash_chart_model')).draw(google.visualization.arrayToDataTable(mA), {...chartOpts, title:'Top Models'});
  new google.visualization.BarChart(document.getElementById('dash_chart_defect')).draw(google.visualization.arrayToDataTable(dA), {...chartOpts, title:'Top Defects'});
}

function editRow(idx){
  let r = currentData[idx]; showPage('entry', document.querySelectorAll('.nav-btn')[1]); 
  document.getElementById('e_date').value = normalizeDate(r[0]); 
  document.getElementById('e_shift').value=r[8]||'A'; document.getElementById('e_line').value=r[1]; document.getElementById('e_model').value=r[2];
  document.getElementById('e_input').value=r[3]; document.getElementById('e_prep').value=r[6];
  document.getElementById('edit_sheet_name').value=r[9]; document.getElementById('edit_index').value=r[10];
  document.getElementById('defect_wrapper').innerHTML="";
  try{ JSON.parse(r[7]).forEach(d=>addDefectRow(d)); }catch(e){ addDefectRow(); } calcTotal();
}

/* -------------------------------------------------------------------------
   REPORT GENERATION LOGIC
------------------------------------------------------------------------- */
function processReportData(rData, inpId, defId, rateId, trendId, paretoId, anaId, remId, modelChartId){
  let totInp=0, totDef=0, dateMap = {}, modelMap = {}, defectsMap = {};
  rData.forEach(r => {
    let d = normalizeDate(r[0]);
    let inp = +r[3], df = +r[4]; totInp += inp; totDef += df;
    if(!dateMap[d]) dateMap[d] = {i:0, d:0}; dateMap[d].i += inp; dateMap[d].d += df;
    if(modelChartId) { if(!modelMap[r[2]]) modelMap[r[2]] = {i:0, d:0}; modelMap[r[2]].i += inp; modelMap[r[2]].d += df; }
    try { JSON.parse(r[7]).forEach(item => { let n = item.name; if(!defectsMap[n]) defectsMap[n] = {qty:0, anaList:[]}; defectsMap[n].qty += (+item.qty); if(item.analysis) defectsMap[n].anaList.push(item.analysis); }); } catch(e){}
  });
  
  document.getElementById(inpId).innerText = totInp; document.getElementById(defId).innerText = totDef; document.getElementById(rateId).innerText = totInp>0 ? (totDef/totInp*100).toFixed(2)+"%" : "0.00%";
  
  let chartOpts = { backgroundColor:'transparent', legend:'none', colors:['#002B5B'] };
  let tData = [['Date', 'Rej %', {role:'annotation'}]]; Object.keys(dateMap).sort().forEach(k => { let v = dateMap[k].i>0?dateMap[k].d/dateMap[k].i*100:0; tData.push([k, v, v.toFixed(1)+'%']); });
  let tChart = new google.visualization.LineChart(document.getElementById(trendId)); tChart.draw(google.visualization.arrayToDataTable(tData), {...chartOpts, title:'Trend %', pointSize:5}); 
  if(trendId === 'mo_trend_chart') chartInstances['mo_trend'] = tChart;

  if(modelChartId) { 
      let mData = [['Model', 'Defect Qty', {role:'annotation'}]]; 
      Object.keys(modelMap).sort((a,b)=>modelMap[b].d - modelMap[a].d).slice(0,10).forEach(k => mData.push([k, modelMap[k].d, modelMap[k].d]));
      let mChart = new google.visualization.ColumnChart(document.getElementById(modelChartId)); 
      mChart.draw(google.visualization.arrayToDataTable(mData), {...chartOpts, colors:['#1A5F7A'], title:'Top Models'}); 
      if(modelChartId === 'mo_model_chart') chartInstances['mo_model'] = mChart; 
  }
  
  let sDef = Object.keys(defectsMap).map(k=>({n:k, ...defectsMap[k]})).sort((a,b)=>b.qty-a.qty);
  if(paretoId){ 
      let pData = [['Defect', 'Qty', {role:'annotation'}]]; 
      sDef.slice(0,10).forEach(s => pData.push([s.n, s.qty, s.qty]));
      let pChart = new google.visualization.ColumnChart(document.getElementById(paretoId)); 
      pChart.draw(google.visualization.arrayToDataTable(pData), {...chartOpts, colors:['#EA5455'], title:'Pareto'}); 
      if(paretoId === 'mo_pareto_chart') chartInstances['mo_pareto'] = pChart; 
  }
  
  if(anaId){ document.getElementById(anaId).innerHTML = sDef.slice(0,5).map(s => `<div class="analysis-card"><strong>${s.n} (Qty: ${s.qty})</strong><p contenteditable="true" style="margin:5px 0 0; color:#555;">${[...new Set(s.anaList)].join(', ') || 'Click to add analysis...'}</p></div>`).join(""); }
  if(remId){ document.getElementById(remId).innerHTML = sDef.slice(5).map(s => `<tr><td>${s.n}</td><td>${s.qty}</td><td>${(s.qty/totInp*100).toFixed(2)}%</td></tr>`).join(""); }
}

function genReport(){
  let s = document.getElementById('r_date_start').value, e = document.getElementById('r_date_end').value;
  let rData = currentData.filter(r => { let d = normalizeDate(r[0]); return d >= s && d <= e; });
  document.getElementById('print_area').style.display = 'block'; document.getElementById('r_subtitle').innerText = `${s} to ${e}`;
  processReportData(rData, 'r_inp', 'r_def', 'r_rate_val', 'trend_chart_div', 'pareto_chart_div', 'analysis_list', 'remaining_list', 'model_chart_div');
}

function genModelReport(){
    let s = document.getElementById('m_date_start').value, e = document.getElementById('m_date_end').value;
    let selectedModels = []; document.querySelectorAll('#checkboxes input:checked').forEach(c => selectedModels.push(c.value));
    if(selectedModels.length === 0) return alert("Select at least one model");
    document.getElementById('m_name_disp').innerText = selectedModels.join(", "); document.getElementById('m_subtitle').innerText = `${s} to ${e}`;
    let rData = currentData.filter(r => { let d = normalizeDate(r[0]); return d >= s && d <= e && selectedModels.includes(r[2]); });
    document.getElementById('model_print_area').style.display = 'block';
    processReportData(rData, 'm_inp', 'm_def', 'm_rate_val', 'm_trend_chart', 'm_pareto_chart', 'm_analysis_list', 'm_remaining_list');
    let xlsHtml = ""; rData.forEach(r => { let dStr = normalizeDate(r[0]); try { JSON.parse(r[7]).forEach(d => { xlsHtml += `<tr><td>${dStr}</td><td>${r[8]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${d.name}</td><td>${d.qty}</td><td>${d.ref||''}</td><td>${d.analysis||''}</td></tr>`; }); } catch(e){} }); document.getElementById('excel_body').innerHTML = xlsHtml;
}

function genDefectWiseReport(){
    let s = document.getElementById('d_date_start').value, e = document.getElementById('d_date_end').value;
    let def = document.getElementById('d_defect_select').value;
    document.getElementById('d_name_disp').innerText = def; document.getElementById('d_subtitle').innerText = `${s} to ${e}`;
    let rData = currentData.filter(r => { let d = normalizeDate(r[0]); return d >= s && d <= e; });
    let mStats = {}, totQty = 0, anaList = [], xlsHtml = "";
    rData.forEach(r => {
        let dStr = normalizeDate(r[0]);
        try { JSON.parse(r[7]).forEach(d => {
            if(d.name === def) {
                let q = +d.qty; totQty += q;
                if(!mStats[r[2]]) mStats[r[2]] = {i:0, q:0}; mStats[r[2]].i += (+r[3]); mStats[r[2]].q += q;
                if(d.analysis) anaList.push({m:r[2], a:d.analysis, ac:d.action});
                xlsHtml += `<tr><td>${dStr}</td><td>${r[8]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${d.name}</td><td>${d.qty}</td><td>${d.analysis||''}</td></tr>`;
            }
        }); } catch(e){}
    });
    document.getElementById('d_tot_qty').innerText = totQty; document.getElementById('d_aff_models').innerText = Object.keys(mStats).length;
    let chartData = [['Model', 'Defect Qty', {role:'annotation'}]], tblHtml = "";
    Object.keys(mStats).sort((a,b)=>mStats[b].q-mStats[a].q).forEach(m => {
        let rate = mStats[m].i > 0 ? (mStats[m].q / mStats[m].i * 100) : 0;
        chartData.push([m, mStats[m].q, mStats[m].q]); 
        tblHtml += `<tr><td>${m}</td><td>${mStats[m].i}</td><td><b>${mStats[m].q}</b></td><td>${rate.toFixed(2)}%</td></tr>`; 
    });
    document.getElementById('defect_detail_body').innerHTML = tblHtml;
    document.getElementById('d_analysis_list').innerHTML = anaList.map(x => `<div class="analysis-card"><strong>${x.m}</strong><p>${x.a}</p></div>`).join("");
    document.getElementById('defect_excel_body').innerHTML = xlsHtml;
    document.getElementById('defect_print_area').style.display='block';
    chartInstances['Defect'] = new google.visualization.ColumnChart(document.getElementById('d_contrib_chart'));
    chartInstances['Defect'].draw(google.visualization.arrayToDataTable(chartData), {legend:'none', title:'By Model', colors:['#EA5455']});
}

function genMonthReport() {
    let mo = document.getElementById('mo_picker').value; if(!mo) return alert("Select Month");
    let rData = currentData.filter(r => normalizeDate(r[0]).startsWith(mo));
    document.getElementById('month_print_area').style.display = 'block'; document.getElementById('mo_subtitle').innerText = "Month: " + mo;
    processReportData(rData, 'mo_inp', 'mo_def', 'mo_rate', 'mo_trend_chart', 'mo_pareto_chart', 'mo_analysis_list', null, 'mo_model_chart');
    let xlsHtml = "";
    rData.forEach(r => {
        let dStr = normalizeDate(r[0]);
        let defects = []; try { defects = JSON.parse(r[7]); } catch(e){}
        if(defects.length === 0) { xlsHtml += `<tr><td>${dStr}</td><td>${r[8]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>-</td><td>0</td><td>-</td><td>-</td></tr>`; } 
        else { defects.forEach(d => { xlsHtml += `<tr><td>${dStr}</td><td>${r[8]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${d.name}</td><td>${d.qty}</td><td>${d.ref||''}</td><td>${d.analysis||''}</td></tr>`; }); }
    });
    document.getElementById('month_excel_body').innerHTML = xlsHtml;
}

function downloadPDF(id, name){ let opt = { margin: 10, filename: name, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } }; html2pdf().from(document.getElementById(id)).set(opt).save(); }
function downloadExcel(id, name){ let html = document.getElementById(id).outerHTML; let link = document.createElement("a"); link.download = name; link.href = 'data:application/vnd.ms-excel,' + escape(html); link.click(); }
function downloadProfessionalPPT(type) {
    let pptx = new PptxGenJS(); pptx.layout = 'LAYOUT_WIDE';
    let s1 = pptx.addSlide(); s1.addImage({ path: LOGO_URL, x: 0.5, y: 0.3, w: 2, h: 0.8 }); s1.background = { color: "F1F1F1" }; s1.addText("Califonix Systems", { x: 0.5, y: 1.5, fontSize: 32, color: "002060", bold: true }); s1.addText(type + " Analysis Report", { x: 0.5, y: 2.5, fontSize: 24, color: "333333" }); s1.addText("Generated on: " + new Date().toDateString(), { x: 0.5, y: 3.5, fontSize: 14, color: "666666" });
    let s2 = pptx.addSlide(); s2.addImage({ path: LOGO_URL, x: 11, y: 0.3, w: 1.5, h: 0.6 }); s2.addText("Performance Overview", { x: 0.5, y: 0.5, fontSize: 20, color: "002060", bold:true });
    if(type === 'Month') {
        let inp = document.getElementById('mo_inp').innerText; let def = document.getElementById('mo_def').innerText; let rate = document.getElementById('mo_rate').innerText;
        s2.addShape(pptx.ShapeType.rect, { x: 1, y: 1.5, w: 3, h: 2, fill: "FFFFFF", line: {color:"002060", width:2} }); s2.addText("Total Input", { x: 1, y: 2, w: 3, align: 'center', fontSize: 14 }); s2.addText(inp, { x: 1, y: 2.5, w: 3, align: 'center', fontSize: 32, bold: true, color: "002060" });
        s2.addShape(pptx.ShapeType.rect, { x: 5, y: 1.5, w: 3, h: 2, fill: "FFFFFF", line: {color:"DC3545", width:2} }); s2.addText("Total Defects", { x: 5, y: 2, w: 3, align: 'center', fontSize: 14 }); s2.addText(def, { x: 5, y: 2.5, w: 3, align: 'center', fontSize: 32, bold: true, color: "DC3545" });
        s2.addShape(pptx.ShapeType.rect, { x: 9, y: 1.5, w: 3, h: 2, fill: "FFFFFF", line: {color:"E36C09", width:2} }); s2.addText("Rejection Rate", { x: 9, y: 2, w: 3, align: 'center', fontSize: 14 }); s2.addText(rate, { x: 9, y: 2.5, w: 3, align: 'center', fontSize: 32, bold: true, color: "E36C09" });
        let s3 = pptx.addSlide(); s3.addImage({ path: LOGO_URL, x: 11, y: 0.3, w: 1.5, h: 0.6 }); s3.addText("Trend & Pareto Analysis", { x: 0.5, y: 0.5, fontSize: 18, color: "002060" }); try { if(chartInstances['mo_trend']) s3.addImage({ data: chartInstances['mo_trend'].getImageURI(), x: 0.5, y: 1, w: 6, h: 3 }); } catch(e){} try { if(chartInstances['mo_pareto']) s3.addImage({ data: chartInstances['mo_pareto'].getImageURI(), x: 7, y: 1, w: 6, h: 3 }); } catch(e){}
        let s4 = pptx.addSlide(); s4.addImage({ path: LOGO_URL, x: 11, y: 0.3, w: 1.5, h: 0.6 }); s4.addText("Model Wise Breakdown", { x: 0.5, y: 0.5, fontSize: 18, color: "002060" }); try { if(chartInstances['mo_model']) s4.addImage({ data: chartInstances['mo_model'].getImageURI(), x: 1, y: 1.5, w: 11, h: 4 }); } catch(e){}
    } else if (type === 'Defect') {
        let s3 = pptx.addSlide(); s3.addImage({ path: LOGO_URL, x: 11, y: 0.3, w: 1.5, h: 0.6 }); s3.addText("Defect Contribution", { x: 0.5, y: 0.5, fontSize: 18, color: "002060" }); try { if(chartInstances['Defect']) s3.addImage({ data: chartInstances['Defect'].getImageURI(), x: 1, y: 1.5, w: 10, h: 4 }); } catch(e){}
    }
    pptx.writeFile({ fileName: `Califonix_${type}_Report.pptx` });
}
</script>
</body>
</html>

